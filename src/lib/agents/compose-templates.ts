/**
 * Compose Templates ‚Äî ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏° "‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°"
 * ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏ó "‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤"
 */
import type { ConversationState } from "./conversation-state";
import { getServiceKnowledge, getServicesForArea } from "./knowledge-base";
import type { ServiceCategory, Area } from "./types";
import { hasFixedArea } from "./types";

/**
 * Template 1a: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏ß (‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå / ‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå / ‡∏£‡∏µ‡∏à‡∏π‡∏£‡∏±‡∏ô)
 * ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠: stage = exploring, service ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î, ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°
 * ‚úÖ FIX 2: ‡πÅ‡∏¢‡∏Å Template Exploring ‡πÄ‡∏õ‡πá‡∏ô 2 ‡πÅ‡∏ö‡∏ö (‡∏ú‡∏¥‡∏ß / ‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°)
 */
export function templateExploringSkin(state: ConversationState): string {
  return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏î‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô  
‚Ä¢ ‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå ‚Üí ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏ï‡πá‡∏°  
‚Ä¢ ‡∏£‡∏µ‡∏à‡∏π‡∏£‡∏±‡∏ô ‚Üí ‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏ú‡∏¥‡∏ß ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏™  
‚Ä¢ ‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå ‚Üí ‡∏•‡∏î‡∏£‡∏¥‡πâ‡∏ß‡∏£‡∏≠‡∏¢ ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤  
‚Ä¢ ‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå / ‡∏ó‡∏£‡∏µ‡∏ï‡πÄ‡∏°‡∏ô‡∏ï‡πå ‚Üí ‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏¥‡∏ß‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°  

‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡∏ß‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Ñ‡∏∞ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡πà‡∏∞ üíï`;
}

/**
 * Template 1b: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° (‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏°‡∏π‡∏Å / ‡∏ï‡∏≤‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô / ‡∏Ñ‡∏≤‡∏á)
 * ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠: stage = exploring, service ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î, ‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°
 * ‚úÖ FIX 2: ‡πÅ‡∏¢‡∏Å Template Exploring ‡πÄ‡∏õ‡πá‡∏ô 2 ‡πÅ‡∏ö‡∏ö (‡∏ú‡∏¥‡∏ß / ‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°)
 */
export function templateExploringSurgery(state: ConversationState): string {
  return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Ç‡∏≠‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏ß‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏î‡πâ‡∏≤‡∏ô‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©  

‡πÄ‡∏ä‡πà‡∏ô  
‚Ä¢ ‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏°‡∏π‡∏Å  
‚Ä¢ ‡∏ï‡∏≤‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô  
‚Ä¢ ‡∏Ñ‡∏≤‡∏á / ‡∏Å‡∏£‡∏≤‡∏°  
‚Ä¢ ‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏∑‡πà‡∏ô ‡πÜ  

‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡πà‡∏∞ üíï`;
}

/**
 * Template 1: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á (fallback - route ‡∏ï‡∏≤‡∏° service category)
 * ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠: stage = exploring, service ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î
 * ‚úÖ FIX 3: Route template ‡∏ï‡∏≤‡∏° "‡∏´‡∏°‡∏ß‡∏î service" ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà intent ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
 */
export function templateExploring(state: ConversationState): string {
  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ service ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô surgery ‚Üí ‡πÉ‡∏ä‡πâ templateExploringSurgery
  if (state.service === "surgery") {
    return templateExploringSurgery(state);
  }
  
  // Default: ‡πÉ‡∏ä‡πâ templateExploringSkin (‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏ß)
  return templateExploringSkin(state);
}

/**
 * Template 2: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì
 * ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠: stage = service_selected
 * üß© FIX 1: FIXED AREA SERVICE ‚Äî ‡∏ñ‡πâ‡∏≤ service ‡∏°‡∏µ FIXED AREA ‚Üí ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡∏ñ‡∏≤‡∏° area
 */
export function templateServiceSelected(state: ConversationState): string {
  // üîß FIX 2: templateServiceSelected ‡∏´‡πâ‡∏≤‡∏°‡∏ñ‡∏≤‡∏° area ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß
  // ‚úÖ ‡∏ñ‡πâ‡∏≤ service + area ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÉ‡∏ä‡πâ templatePricing ‡πÄ‡∏™‡∏°‡∏≠
  // ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡∏ñ‡∏≤‡∏°‡∏ã‡πâ‡∏≥
  // ‚ùå ‡∏´‡πâ‡∏≤‡∏° UX ‡πÅ‡∏õ‡∏•‡∏Å
  if (state.service && state.area && state.area !== "unknown") {
    // ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á service ‡πÅ‡∏•‡∏∞ area ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÉ‡∏ä‡πâ templatePricing
    return templatePricing(state);
  }
  
  // üß© FIX 1: Guard ‚Äî ‡∏ñ‡πâ‡∏≤ service ‡∏°‡∏µ FIXED AREA ‚Üí ‡πÉ‡∏ä‡πâ templatePricing ‡πÅ‡∏ó‡∏ô
  if (state.service) {
    const fixedArea = hasFixedArea(state.service);
    if (fixedArea) {
      // ‡∏°‡∏µ FIXED AREA ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏° area ‚Üí ‡πÉ‡∏ä‡πâ templatePricing
      return templatePricing({
        ...state,
        area: fixedArea,
      });
    }
  }
  
  const serviceInfo = state.service ? getServiceKnowledge(state.service, state.area) : null;
  const serviceName = state.service === "filler" ? "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå" 
    : state.service === "rejuran" ? "‡∏£‡∏µ‡∏à‡∏π‡∏£‡∏±‡∏ô"
    : state.service === "botox" ? "‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå"
    : state.service === "laser" ? "‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå"
    : state.service === "surgery" ? "‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏°‡∏π‡∏Å"
    : state.service === "skin" ? "‡∏ó‡∏£‡∏µ‡∏ï‡πÄ‡∏°‡∏ô‡∏ï‡πå"
    : state.service === "lifting" ? "‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤"
    : String(state.service);

  if (serviceInfo && serviceInfo.areas.length > 0) {
    const areaNames = serviceInfo.areas.map(a => 
      a === "lip" ? "‡∏õ‡∏≤‡∏Å" :
      a === "chin" ? "‡∏Ñ‡∏≤‡∏á" :
      a === "under_eye" ? "‡πÉ‡∏ï‡πâ‡∏ï‡∏≤" :
      a === "forehead" ? "‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏≤‡∏Å" :
      a === "brow" ? "‡∏Ñ‡∏¥‡πâ‡∏ß" :
      a === "jaw" ? "‡∏Å‡∏£‡∏≤‡∏°" :
      a === "cheek" ? "‡πÅ‡∏Å‡πâ‡∏°" :
      a === "face" ? "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤" : a
    ).join(" ");

    return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ${serviceName} ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞  
‡∏™‡∏ô‡πÉ‡∏à‡∏ó‡∏≥‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Ñ‡∏∞ ‡πÄ‡∏ä‡πà‡∏ô ${areaNames}  
‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ä‡πá‡∏Å‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏à‡∏∏‡∏î‡∏Ñ‡πà‡∏∞ ‚ú®`;
  }

  return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ${serviceName} ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞  
‡∏™‡∏ô‡πÉ‡∏à‡∏ó‡∏≥‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Ñ‡∏∞ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ä‡πá‡∏Å‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏à‡∏∏‡∏î‡∏Ñ‡πà‡∏∞ ‚ú®`;
}

/**
 * Template 3: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡πÇ‡∏õ‡∏£
 * ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠: stage = pricing, ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á service + area
 */
export function templatePricing(state: ConversationState): string {
  // ‚ö†Ô∏è Guard: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ service ‡∏à‡∏£‡∏¥‡∏á ‚Üí ‡πÉ‡∏ä‡πâ template exploring (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏î‡∏≤)
  if (!state.service) {
    return templateExploring(state);
  }
  
  const serviceInfo = getServiceKnowledge(state.service, state.area);
  if (!serviceInfo) return templateServiceSelected(state);

  const serviceName = state.service === "filler" ? "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå" 
    : state.service === "rejuran" ? "‡∏£‡∏µ‡∏à‡∏π‡∏£‡∏±‡∏ô"
    : state.service === "botox" ? "‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå"
    : state.service === "laser" ? "‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå"
    : state.service === "surgery" ? "‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏°‡∏π‡∏Å"
    : state.service === "skin" ? "‡∏ó‡∏£‡∏µ‡∏ï‡πÄ‡∏°‡∏ô‡∏ï‡πå"
    : state.service === "lifting" ? "‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤"
    : String(state.service);

  const areaName = state.area === "lip" ? "‡∏õ‡∏≤‡∏Å"
    : state.area === "chin" ? "‡∏Ñ‡∏≤‡∏á"
    : state.area === "nose" ? "‡∏à‡∏°‡∏π‡∏Å"
    : state.area === "under_eye" ? "‡πÉ‡∏ï‡πâ‡∏ï‡∏≤"
    : state.area === "forehead" ? "‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏≤‡∏Å"
    : state.area === "brow" ? "‡∏Ñ‡∏¥‡πâ‡∏ß"
    : state.area === "jaw" ? "‡∏Å‡∏£‡∏≤‡∏°"
    : state.area === "cheek" ? "‡πÅ‡∏Å‡πâ‡∏°"
    : state.area === "face" ? "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤"
    : "";

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ area ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏ö‡∏ö‡∏Å‡∏ß‡πâ‡∏≤‡∏á ‡πÜ ‡πÅ‡∏•‡∏∞‡∏ñ‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì
  if (!areaName) {
    const areaOptions = serviceInfo.areas.slice(0, 3).map(a => 
      a === "lip" ? "‡∏õ‡∏≤‡∏Å" 
      : a === "chin" ? "‡∏Ñ‡∏≤‡∏á" 
      : a === "under_eye" ? "‡πÉ‡∏ï‡πâ‡∏ï‡∏≤"
      : a === "forehead" ? "‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏≤‡∏Å"
      : a === "brow" ? "‡∏Ñ‡∏¥‡πâ‡∏ß"
      : a === "face" ? "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤"
      : a
    ).join(" ");

    return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä ${serviceName}‡∏£‡∏≤‡∏Ñ‡∏≤${serviceInfo.priceRange}‡∏Ñ‡πà‡∏∞  
${serviceInfo.note ? `${serviceInfo.note} ` : ""}‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì ‡πÄ‡∏ä‡πà‡∏ô ${areaOptions}  

‡∏™‡∏ô‡πÉ‡∏à‡∏ó‡∏≥‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Ñ‡∏∞ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏ä‡πá‡∏Å‡πÇ‡∏õ‡∏£‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞ ‚ú®`;
  }

  // ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á service + area ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÇ‡∏õ‡∏£‡πÄ‡∏ï‡πá‡∏°
  // üß© FIX 3: Template Pricing ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å "Surgery" ‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏°‡∏π‡∏Å
  // ‚ùå ‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏•‡∏Ç‡∏°‡∏±‡πà‡∏ß
  // ‚úÖ ‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏à‡∏£‡∏¥‡∏á
  // ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£: ‡∏£‡∏≤‡∏Ñ‡∏≤ ‚â† ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô (‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)
  
  if (state.service === "surgery" && state.area === "nose") {
    const tone = state.tone || "short"; // default = short
    
    // ‚úÖ Human First Rule: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ preference ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
    // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ preference ‚Üí ‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô (‡πÑ‡∏°‡πà‡πÄ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
    if (!state.preference?.style) {
      // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ preference ‚Üí ‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô
      return templateAskNosePreference();
    }
    
    // ‚úÖ Tone Check: ‡∏ñ‡πâ‡∏≤ tone = short ‚Üí ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß / ‡πÑ‡∏°‡πà‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
    if (tone === "short") {
      return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä`;
    }
    
    // ‡∏°‡∏µ preference ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° preference
    const style = state.preference.style;
    const concern = state.preference.concern;
    const intensity = state.preference.intensity;
    
    // ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏ï‡∏≤‡∏° preference (‡πÑ‡∏°‡πà‡πÄ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
    let responseText = `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä`;
    
    // üîµ ‡πÇ‡∏´‡∏°‡∏î 3: ‡∏ñ‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á ‚Üí ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô ‡πÜ (‡πÑ‡∏°‡πà‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£)
    if (tone === "explain") {
      if (style === "‡πÇ‡∏î‡πà‡∏á") {
        responseText += `\n‡∏ñ‡πâ‡∏≤‡∏ä‡∏≠‡∏ö‡∏ó‡∏£‡∏á‡∏à‡∏°‡∏π‡∏Å‡πÅ‡∏ö‡∏ö‡πÇ‡∏î‡πà‡∏á ‡∏à‡∏∞‡∏°‡∏µ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ô‡πâ‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏û‡∏∏‡πà‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤`;
      } else if (style === "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥") {
        responseText += `\n‡∏ñ‡πâ‡∏≤‡∏ä‡∏≠‡∏ö‡∏ó‡∏£‡∏á‡∏à‡∏°‡∏π‡∏Å‡πÅ‡∏ö‡∏ö‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏Ñ‡πà‡∏∞`;
      } else if (style === "‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ") {
        responseText += `\n‡∏ñ‡πâ‡∏≤‡∏ä‡∏≠‡∏ö‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ ‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡πÇ‡∏î‡πà‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞`;
      }
      
      if (intensity === "‡πÄ‡∏ö‡∏≤" || intensity === "‡πÑ‡∏°‡πà‡πÄ‡∏ß‡∏≠‡∏£‡πå") {
        responseText += `\n‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ö‡∏≤ ‡πÑ‡∏°‡πà‡πÄ‡∏ß‡∏≠‡∏£‡πå ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡πà‡∏∞ ‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏à‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÅ‡∏•‡∏∞‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏Ñ‡πà‡∏∞`;
      }
      
      if (concern) {
        responseText += `\n‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á${concern} ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡πà‡∏∞ ‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏à‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡πà‡∏∞`;
      }
      
      responseText += `\n\n‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏∞ üòä`;
    } else {
      // tone = medium ‚Üí ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÑ‡∏î‡πâ 1 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ
      if (style === "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥") {
        responseText += `\n‡∏ó‡∏£‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏î‡∏π‡πÑ‡∏°‡πà‡∏´‡∏•‡∏≠‡∏Å‡∏Ñ‡πà‡∏∞`;
      } else if (style === "‡πÇ‡∏î‡πà‡∏á") {
        responseText += `\n‡∏ó‡∏£‡∏á‡πÇ‡∏î‡πà‡∏á‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏Ñ‡πà‡∏∞`;
      } else if (style === "‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ") {
        responseText += `\n‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏Ñ‡πà‡∏∞`;
      }
      
      responseText += `\n\n‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏∞ üòä`;
    }
    
    return responseText;
  }
  
  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô surgery ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ template ‡πÄ‡∏â‡∏û‡∏≤‡∏∞)
  if (state.service === "surgery") {
    return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
${serviceName} ‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡πà‡∏∞  

‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ ‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞  

‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏ô‡∏ß‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Ñ‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üíï`;
  }

  // ‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ + ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏≠‡∏∞‡πÑ‡∏£
  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÇ‡∏õ‡∏£ ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏¢‡∏Å (‡πÑ‡∏°‡πà‡∏õ‡∏ô‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤)
  const priceText = serviceInfo.priceNote 
    ? `${serviceInfo.priceRange} (${serviceInfo.priceNote})`
    : serviceInfo.priceRange;
  
  const promotionText = serviceInfo.promotion 
    ? `\n\n‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ${serviceInfo.promotion}${serviceInfo.promotionCondition ? ` (${serviceInfo.promotionCondition})` : ""}`
    : "";
  
  return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
${serviceName} ‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì ${areaName}  
‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${priceText}‡∏Ñ‡πà‡∏∞${promotionText}  

‡∏ñ‡πâ‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß ‡∏ö‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üíï`;
}

/**
 * Template 4: ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≠‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô "‡∏£‡∏µ‡∏à‡∏π‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö")
 * ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠: isShortFollowUp = true
 */
export function templateShortFollowUp(
  message: string,
  state: ConversationState
): string {
  // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤ service ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
  const lower = message.toLowerCase();
  let detectedService: ServiceCategory | null = null;
  
  if (/‡∏£‡∏µ‡∏à‡∏π‡∏£‡∏±‡∏ô|rejuran/.test(lower)) detectedService = "rejuran";
  else if (/‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå|filler/.test(lower)) detectedService = "filler";
  else if (/‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå|botox/.test(lower)) detectedService = "botox";
  else if (/‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå|laser/.test(lower)) detectedService = "laser";
  else if (/‡∏ó‡∏£‡∏µ‡∏ï‡πÄ‡∏°‡∏ô‡∏ï‡πå|facial/.test(lower)) detectedService = "skin";
  else if (/‡∏¢‡∏Å|hifu|ultra/.test(lower)) detectedService = "lifting";

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠ service ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‚Üí ‡πÉ‡∏ä‡πâ service ‡∏ô‡∏±‡πâ‡∏ô
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÅ‡∏ï‡πà state ‡∏°‡∏µ service ‚Üí ‡πÉ‡∏ä‡πâ service ‡∏à‡∏≤‡∏Å state
  const serviceToUse = detectedService || (state.service as ServiceCategory) || null;

  if (serviceToUse) {
    const serviceInfo = getServiceKnowledge(serviceToUse, state.area);
    if (serviceInfo) {
      const serviceName = serviceToUse === "filler" ? "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå" 
        : serviceToUse === "rejuran" ? "‡∏£‡∏µ‡∏à‡∏π‡∏£‡∏±‡∏ô"
        : serviceToUse === "botox" ? "‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå"
        : serviceToUse === "laser" ? "‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå"
        : serviceToUse === "skin" ? "‡∏ó‡∏£‡∏µ‡∏ï‡πÄ‡∏°‡∏ô‡∏ï‡πå"
        : serviceToUse === "lifting" ? "‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤"
        : String(serviceToUse);

      const areaText = serviceInfo.areas.length > 1 
        ? "‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì ‡πÄ‡∏ä‡πà‡∏ô " + serviceInfo.areas.slice(0, 3).map(a => 
            a === "lip" ? "‡∏õ‡∏≤‡∏Å" 
            : a === "chin" ? "‡∏Ñ‡∏≤‡∏á" 
            : a === "under_eye" ? "‡πÉ‡∏ï‡πâ‡∏ï‡∏≤"
            : a === "forehead" ? "‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏≤‡∏Å"
            : a === "brow" ? "‡∏Ñ‡∏¥‡πâ‡∏ß"
            : a === "face" ? "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤"
            : a
          ).join(" ")
        : "‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì" + (serviceInfo.areas[0] === "face" ? "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤" : "");

      return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä ${serviceName}${serviceInfo.description ? ` ${serviceInfo.description}` : ""}  
‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏≥‡πÑ‡∏î‡πâ${areaText}‡∏ô‡∏∞‡∏Ñ‡∏∞  
‡∏™‡∏ô‡πÉ‡∏à‡∏ó‡∏≥‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÑ‡∏´‡∏ô ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏ä‡πá‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡πÇ‡∏õ‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏∞ ‚ú®`;
    }
  }

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ service ‚Üí ‡πÉ‡∏ä‡πâ template exploring
  return templateExploring(state);
}

/**
 * Template 5: ‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå (‡∏´‡πâ‡∏≤‡∏° AI ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÄ‡∏≠‡∏á)
 * 6Ô∏è‚É£ medical_question / aftercare_question
 * ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤:
 * ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ context ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
 * ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏π‡∏î‡πÇ‡∏õ‡∏£
 * ‚úÖ ‡∏õ‡∏•‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô + ‡∏™‡πà‡∏á‡∏´‡∏°‡∏≠ / ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
 */
export function templateMedical(): string {
  return `‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡πà‡∏∞ üòä  
‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏à‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡πà‡∏∞  
‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏î‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞ üíï`;
}

/**
 * Template 7: service_information (‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á / ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á)
 * 2Ô∏è‚É£ service_information
 * ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤:
 * - ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ service ‚Üí ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ service ‡∏ô‡∏±‡πâ‡∏ô (‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏¢‡πà‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
 * - ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ service ‚Üí ‡πÅ‡∏™‡∏î‡∏á option ‡πÅ‡∏ö‡∏ö‡∏Å‡∏ß‡πâ‡∏≤‡∏á
 * ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏≤‡∏¢
 * ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏π‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°)
 */
export function templateServiceInformation(state: ConversationState): string {
  if (state.service) {
    // üîµ ‡πÇ‡∏´‡∏°‡∏î 3: ‡∏ñ‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á ‚Üí ‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (‡πÑ‡∏°‡πà‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£)
    // ‡∏ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (service_information intent) ‚Üí ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
    
    const tone = state.tone || "short"; // default = short
    const serviceInfo = getServiceKnowledge(state.service, state.area);
    if (serviceInfo) {
      const serviceName = state.service === "filler" ? "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå" 
        : state.service === "rejuran" ? "‡∏£‡∏µ‡∏à‡∏π‡∏£‡∏±‡∏ô"
        : state.service === "botox" ? "‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå"
        : state.service === "laser" ? "‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå"
        : state.service === "surgery" && state.area === "nose" ? "‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏°‡∏π‡∏Å"
        : state.service === "surgery" && state.area === "eye" ? "‡∏ï‡∏≤‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô"
        : state.service === "surgery" ? "‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°"
        : state.service === "skin" ? "‡∏ó‡∏£‡∏µ‡∏ï‡πÄ‡∏°‡∏ô‡∏ï‡πå"
        : state.service === "lifting" ? "‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤"
        : String(state.service);
      
      // ‚úÖ Tone Check: ‡∏ñ‡πâ‡∏≤ tone = short ‚Üí ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß / ‡πÑ‡∏°‡πà‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
      if (tone === "short" && state.service === "surgery") {
        return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä`;
      }
      
      // üîµ ‡πÇ‡∏´‡∏°‡∏î 3: ‡∏ñ‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á ‚Üí ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô ‡πÜ (‡πÑ‡∏°‡πà‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£)
      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ preference ‚Üí ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° preference
      if (state.service === "surgery" && state.area === "nose" && state.preference?.style) {
        const style = state.preference.style;
        let infoText = `${serviceName}`;
        
        // tone = explain ‚Üí ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÑ‡∏î‡πâ, tone = medium ‚Üí ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ 1 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ
        if (tone === "explain") {
          if (style === "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥") {
            infoText += ` ‡∏ó‡∏£‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏î‡∏π‡πÑ‡∏°‡πà‡∏´‡∏•‡∏≠‡∏Å‡∏Ñ‡πà‡∏∞`;
          } else if (style === "‡πÇ‡∏î‡πà‡∏á" || style === "‡∏õ‡∏•‡∏≤‡∏¢‡∏û‡∏∏‡πà‡∏á") {
            infoText += ` ‡∏ó‡∏£‡∏á‡πÇ‡∏î‡πà‡∏á‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏Ñ‡πà‡∏∞`;
          } else if (style === "‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ") {
            infoText += ` ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏Ñ‡πà‡∏∞`;
          }
          infoText += ` ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏∞ üòä`;
        } else if (tone === "medium") {
          if (style === "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥") {
            infoText += ` ‡∏ó‡∏£‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏î‡∏π‡πÑ‡∏°‡πà‡∏´‡∏•‡∏≠‡∏Å‡∏Ñ‡πà‡∏∞`;
          } else if (style === "‡πÇ‡∏î‡πà‡∏á") {
            infoText += ` ‡∏ó‡∏£‡∏á‡πÇ‡∏î‡πà‡∏á‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏Ñ‡πà‡∏∞`;
          } else if (style === "‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ") {
            infoText += ` ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏Ñ‡πà‡∏∞`;
          }
          infoText += ` üòä`;
        }
        
        return infoText;
      }
      
      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ preference ‚Üí ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡πâ‡∏ô ‡πÜ
      if (state.service === "surgery") {
        if (tone === "short") {
          return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä`;
        }
        return `${serviceName} ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏∞ üòä`;
      }
      
      // ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‚Üí ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏™‡∏±‡πâ‡∏ô)
      let infoText = `${serviceName} ${serviceInfo.description}`;
      
      if (serviceInfo.suitableFor) {
        infoText += ` ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö: ${serviceInfo.suitableFor}`;
      }
      
      return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
${infoText}  

${serviceInfo.note ? `${serviceInfo.note} ` : ""}‡∏ñ‡πâ‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô ‡∏ö‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‚ú®`;
    }
  }
  
  // ‡πÑ‡∏°‡πà‡∏°‡∏µ service ‚Üí ‡πÅ‡∏™‡∏î‡∏á option ‡πÅ‡∏ö‡∏ö‡∏Å‡∏ß‡πâ‡∏≤‡∏á (‡πÉ‡∏ä‡πâ templateExploring)
  return templateExploring(state);
}

/**
 * Template 9: comparison_inquiry (‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)
 * üîß ‡πÄ‡∏û‡∏¥‡πà‡∏°: comparison_inquiry
 * ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤:
 * - ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡πÑ‡∏°‡πà‡∏ü‡∏±‡∏ô‡∏ò‡∏á
 * - ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ "‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ú‡∏¥‡∏ß / ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô"
 */
export function templateComparison(state: ConversationState, userMessage: string): string {
  // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤ service ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
  const lower = userMessage.toLowerCase();
  const services: Array<{ name: string; info: ReturnType<typeof getServiceKnowledge> }> = [];
  
  if (/‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå|filler/.test(lower)) {
    const info = getServiceKnowledge("filler");
    if (info) services.push({ name: "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå", info });
  }
  if (/‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå|botox/.test(lower)) {
    const info = getServiceKnowledge("botox");
    if (info) services.push({ name: "‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå", info });
  }
  if (/‡∏£‡∏µ‡∏à‡∏π‡∏£‡∏±‡∏ô|rejuran/.test(lower)) {
    const info = getServiceKnowledge("rejuran");
    if (info) services.push({ name: "‡∏£‡∏µ‡∏à‡∏π‡∏£‡∏±‡∏ô", info });
  }
  if (/‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå|laser/.test(lower)) {
    const info = getServiceKnowledge("laser");
    if (info) services.push({ name: "‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå", info });
  }
  if (/‡∏¢‡∏Å|hifu|ultra/.test(lower)) {
    const info = getServiceKnowledge("lifting");
    if (info) services.push({ name: "‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤", info });
  }
  if (/‡∏£‡πâ‡∏≠‡∏¢‡πÑ‡∏´‡∏°/.test(lower)) {
    // ‡∏£‡πâ‡∏≠‡∏¢‡πÑ‡∏´‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô knowledge base ‚Üí ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    services.push({ name: "‡∏£‡πâ‡∏≠‡∏¢‡πÑ‡∏´‡∏°", info: null });
  }
  
  if (services.length >= 2) {
    // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡πÑ‡∏°‡πà‡∏ü‡∏±‡∏ô‡∏ò‡∏á
    let comparisonText = `${services[0].name} ${services[0].info?.description || "‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤"}`;
    if (services[0].info?.suitableFor) {
      comparisonText += ` ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö${services[0].info.suitableFor}`;
    }
    
    comparisonText += `\n\n${services[1].name} ${services[1].info?.description || "‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤"}`;
    if (services[1].info?.suitableFor) {
      comparisonText += ` ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö${services[1].info.suitableFor}`;
    }
    
    return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
${services[0].name} ‡πÅ‡∏•‡∏∞ ${services[1].name} ‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏∞  

${comparisonText}

‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ú‡∏¥‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞  
‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡πà‡∏∞ üíï`;
  }
  
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ service ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‚Üí ‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö
  return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏ö‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏ô  
‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ñ‡πà‡∏∞ ‚ú®`;
}

/**
 * Template 10: hesitation (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏á‡πÄ‡∏•/‡∏Å‡∏•‡∏±‡∏ß)
 * üîß ‡πÄ‡∏û‡∏¥‡πà‡∏°: hesitation
 * ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤:
 * - ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å) ‚Äî normalize ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ß
 * - ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡πâ‡∏ô
 * - ‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏∏‡∏¢‡∏ï‡πà‡∏≠ ‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏Ç‡∏≤‡∏¢
 */
export function templateHesitation(state: ConversationState, userMessage: string): string {
  const lower = userMessage.toLowerCase();
  
  // ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏Å‡πà‡∏≠‡∏ô
  let empathyText = "‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡πà‡∏∞ üòä";
  if (/‡∏Å‡∏•‡∏±‡∏ß/.test(lower)) {
    empathyText = "‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏Ñ‡πà‡∏∞ üòä";
  } else if (/‡∏•‡∏±‡∏á‡πÄ‡∏•|‡πÑ‡∏°‡πà‡∏Å‡∏•‡πâ‡∏≤/.test(lower)) {
    empathyText = "‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡πà‡∏∞ üòä";
  } else if (/‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏´‡πá‡∏ô|‡πÄ‡∏Ñ‡∏™‡∏´‡∏•‡∏∏‡∏î|‡∏û‡∏±‡∏á/.test(lower)) {
    empathyText = "‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏Ñ‡πà‡∏∞ üòä";
  }
  
  // Normalize ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ß
  let normalizeText = "‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏π‡∏á‡∏Ñ‡πà‡∏∞";
  if (state.service === "surgery") {
    normalizeText = "‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏π‡∏á‡∏Ñ‡πà‡∏∞ ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡πÑ‡∏î‡πâ";
  }
  
  // ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡πâ‡∏ô
  let infoText = "";
  if (state.service) {
    const serviceInfo = getServiceKnowledge(state.service, state.area);
    if (serviceInfo && serviceInfo.risks) {
      infoText = `\n${serviceInfo.risks}`;
    }
  }
  
  // ‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏∏‡∏¢‡∏ï‡πà‡∏≠ ‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏Ç‡∏≤‡∏¢
  return `${empathyText}  
${normalizeText}${infoText}  

‡∏ñ‡πâ‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à ‡∏ö‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞  
‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏∞ üíï`;
}

/**
 * Template 8: availability_check (‡∏Ñ‡∏¥‡∏ß‡∏ß‡πà‡∏≤‡∏á)
 * 4Ô∏è‚É£ availability_check
 * ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤:
 * ‚ùå templatePricing (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î)
 * ‚ùå ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î)
 * ‚úÖ templateAvailability ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‚Äî ‡∏ñ‡∏≤‡∏°‡∏ß‡∏±‡∏ô/‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
 */
export function templateAvailability(state: ConversationState): string {
  if (!state.service) {
    return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞  
‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏∞ üíï`;
  }
  
  const serviceName = state.service === "filler" ? "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå" 
    : state.service === "rejuran" ? "‡∏£‡∏µ‡∏à‡∏π‡∏£‡∏±‡∏ô"
    : state.service === "botox" ? "‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå"
    : state.service === "laser" ? "‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå"
    : state.service === "surgery" ? "‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏°‡∏π‡∏Å"
    : state.service === "skin" ? "‡∏ó‡∏£‡∏µ‡∏ï‡πÄ‡∏°‡∏ô‡∏ï‡πå"
    : state.service === "lifting" ? "‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤"
    : String(state.service);
  
  const areaName = state.area === "lip" ? "‡∏õ‡∏≤‡∏Å"
    : state.area === "chin" ? "‡∏Ñ‡∏≤‡∏á"
    : state.area === "under_eye" ? "‡πÉ‡∏ï‡πâ‡∏ï‡∏≤"
    : state.area === "forehead" ? "‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏≤‡∏Å"
    : state.area === "brow" ? "‡∏Ñ‡∏¥‡πâ‡∏ß"
    : state.area === "jaw" ? "‡∏Å‡∏£‡∏≤‡∏°"
    : state.area === "cheek" ? "‡πÅ‡∏Å‡πâ‡∏°"
    : state.area === "face" ? "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤"
    : state.area === "nose" ? "‡∏à‡∏°‡∏π‡∏Å"
    : "";
  
  if (areaName) {
    return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${serviceName} ‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì ${areaName} ‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞  
‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏∞ üíï`;
  }
  
  return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${serviceName} ‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞  
‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏∞ üíï`;
}

/**
 * Template 11: refinement (‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πÑ‡∏ï‡∏•‡πå)
 * üîß FIX 1: refinement ‚Äî ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°
 * ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤:
 * - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏π‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
 * - ‡πÑ‡∏°‡πà‡πÄ‡∏î‡∏≤
 * - ‡πÑ‡∏°‡πà‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏°‡∏ß‡∏î
 * - ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå
 */
export function templateRefinement(
  state: ConversationState,
  message: string
): string {
  const lower = message.toLowerCase();
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô refinement ‡∏≠‡∏∞‡πÑ‡∏£
  let refinementType = "";
  if (/‡πÇ‡∏î‡πà‡∏á|‡∏û‡∏∏‡πà‡∏á/.test(lower)) {
    refinementType = "‡πÇ‡∏î‡πà‡∏á";
  } else if (/‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥/.test(lower)) {
    refinementType = "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥";
  } else if (/‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ/.test(lower)) {
    refinementType = "‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ";
  } else if (/‡∏™‡∏≤‡∏¢‡∏ù‡∏≠/.test(lower)) {
    refinementType = "‡∏™‡∏≤‡∏¢‡∏ù‡∏≠";
  } else if (/‡∏Ñ‡∏°/.test(lower)) {
    refinementType = "‡∏Ñ‡∏°";
  } else if (/‡∏´‡∏ß‡∏≤‡∏ô/.test(lower)) {
    refinementType = "‡∏´‡∏ß‡∏≤‡∏ô";
  }
  
  const serviceName = state.service === "surgery" && state.area === "nose" 
    ? "‡∏à‡∏°‡∏π‡∏Å"
    : state.service === "filler" ? "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå"
    : state.service === "rejuran" ? "‡∏£‡∏µ‡∏à‡∏π‡∏£‡∏±‡∏ô"
    : state.service === "botox" ? "‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå"
    : state.service === "laser" ? "‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå"
    : String(state.service);
  
  // ‚úÖ Human First Rule: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô surgery + nose ‡πÅ‡∏•‡∏∞‡∏°‡∏µ preference ‡πÅ‡∏•‡πâ‡∏ß
  // ‚Üí ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏ï‡∏≤‡∏° preference (‡πÑ‡∏°‡πà‡πÄ‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
  if (state.service === "surgery" && state.area === "nose") {
    const tone = state.tone || "short"; // default = short
    
    // ‚úÖ Tone Check: ‡∏ñ‡πâ‡∏≤ tone = short ‚Üí ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß / ‡πÑ‡∏°‡πà‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
    if (tone === "short") {
      return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä`;
    }
    
    const style = state.preference?.style || refinementType;
    const concern = state.preference?.concern;
    const intensity = state.preference?.intensity;
    
    let responseText = `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä`;
    
    // tone = explain ‚Üí ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÑ‡∏î‡πâ, tone = medium ‚Üí ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ 1 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ
    if (tone === "explain") {
      if (style === "‡πÇ‡∏î‡πà‡∏á") {
        responseText += `\n‡∏ñ‡πâ‡∏≤‡∏ä‡∏≠‡∏ö‡∏ó‡∏£‡∏á‡∏à‡∏°‡∏π‡∏Å‡πÅ‡∏ö‡∏ö‡πÇ‡∏î‡πà‡∏á ‡∏à‡∏∞‡∏°‡∏µ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ô‡πâ‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏û‡∏∏‡πà‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤`;
      } else if (style === "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥") {
        responseText += `\n‡∏ñ‡πâ‡∏≤‡∏ä‡∏≠‡∏ö‡∏ó‡∏£‡∏á‡∏à‡∏°‡∏π‡∏Å‡πÅ‡∏ö‡∏ö‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏Ñ‡πà‡∏∞`;
      } else if (style === "‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ") {
        responseText += `\n‡∏ñ‡πâ‡∏≤‡∏ä‡∏≠‡∏ö‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ ‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡πÇ‡∏î‡πà‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞`;
      } else if (refinementType) {
        responseText += `\n‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ ‡∏à‡∏∞‡∏°‡∏µ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞`;
      }
      
      if (intensity === "‡πÄ‡∏ö‡∏≤" || intensity === "‡πÑ‡∏°‡πà‡πÄ‡∏ß‡∏≠‡∏£‡πå") {
        responseText += `\n‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ö‡∏≤ ‡πÑ‡∏°‡πà‡πÄ‡∏ß‡∏≠‡∏£‡πå ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡πà‡∏∞ ‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏à‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÅ‡∏•‡∏∞‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏Ñ‡πà‡∏∞`;
      }
      
      if (concern) {
        responseText += `\n‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á${concern} ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡πà‡∏∞ ‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏à‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡πà‡∏∞`;
      }
      
      responseText += `\n\n‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏∞ üòä`;
    } else if (tone === "medium") {
      // tone = medium ‚Üí ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÑ‡∏î‡πâ 1 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ
      if (style === "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥") {
        responseText += `\n‡∏ó‡∏£‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏î‡∏π‡πÑ‡∏°‡πà‡∏´‡∏•‡∏≠‡∏Å‡∏Ñ‡πà‡∏∞`;
      } else if (style === "‡πÇ‡∏î‡πà‡∏á") {
        responseText += `\n‡∏ó‡∏£‡∏á‡πÇ‡∏î‡πà‡∏á‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏Ñ‡πà‡∏∞`;
      } else if (style === "‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ") {
        responseText += `\n‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ‡∏à‡∏∞‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏Ñ‡πà‡∏∞`;
      }
      responseText += ` üòä`;
    }
    
    return responseText;
  }
  
  // ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
  return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
${refinementType ? `‡∏ñ‡πâ‡∏≤‡∏ä‡∏≠‡∏ö${refinementType} ` : ""}‡∏à‡∏∞‡∏°‡∏µ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞  
‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞  

‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üíï`;
}

/**
 * Template 12a: ‡∏ñ‡∏≤‡∏° preference ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏°‡∏π‡∏Å (‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ô - ‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà)
 * ‚úÖ Human First Rule: ‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
 * ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠: ‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏°‡∏π‡∏Å ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ preference (‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà)
 * 
 * üü¢ ‡πÇ‡∏´‡∏°‡∏î 1: ‡πÅ‡∏Ñ‡πà‡∏ó‡∏±‡∏Å / ‡∏™‡∏ô‡πÉ‡∏à ‚Üí ‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÜ 1 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
 * 
 * ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å:
 * - ‡πÑ‡∏°‡πà‡∏°‡∏µ bullet
 * - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏Å‡∏±‡∏á‡∏ß‡∏• / ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô / ‡πÄ‡∏Ñ‡∏™"
 * - ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏î
 * - ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏™‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
 */
export function templateAskNosePreferenceHuman(): string {
  return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏£‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞ ‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ‡∏î‡∏µ‡∏Ñ‡∏∞`;
}

/**
 * Template ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏≤ (‡∏ó‡∏≥‡∏ï‡∏≤)
 * üü¢ ‡πÇ‡∏´‡∏°‡∏î 1: ‡πÅ‡∏Ñ‡πà‡∏ó‡∏±‡∏Å / ‡∏™‡∏ô‡πÉ‡∏à ‚Üí ‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÜ 1 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
 */
export function templateAskEyePreferenceHuman(): string {
  return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏™‡∏ô‡πÉ‡∏à‡∏ï‡∏≤‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞ ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å ‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏Ñ‡∏∞`;
}

/**
 * Template 12: ‡∏ñ‡∏≤‡∏° preference ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏°‡∏π‡∏Å (‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡∏Ñ‡∏∏‡∏¢‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß)
 * ‚úÖ Human First Rule: ‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
 * ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠: service = surgery, area = nose, ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ preference.style (‡∏Ñ‡∏∏‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)
 * 
 * ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å:
 * - ‡∏ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡∏´‡πâ‡∏≤‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
 * - ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏Ñ‡πà "‡∏ö‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à" ‚Üí ‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô 1-2 ‡∏à‡∏∏‡∏î
 * - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ
 * - ‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ
 * - ‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏™‡∏î‡∏∏
 * - ‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤
 * - ‚úÖ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á
 * - ‚úÖ ‡∏û‡∏π‡∏î‡∏™‡∏±‡πâ‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏¥‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£
 */
export function templateAskNosePreference(): string {
  return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏Ç‡∏≠‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏£‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞  

‡πÄ‡∏ä‡πà‡∏ô  
‚Ä¢ ‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥  
‚Ä¢ ‡∏õ‡∏•‡∏≤‡∏¢‡∏û‡∏∏‡πà‡∏á  
‚Ä¢ ‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ  

‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏°‡∏π‡∏Å‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞  
‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡∏Ñ‡πà‡∏∞ üíï`;
}

/**
 * Template 12b: Acknowledge + ‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏î‡πâ style ‡πÅ‡∏•‡πâ‡∏ß
 * ‚úÖ Human First Rule: acknowledge ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏≤‡∏°
 * ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö preference (‡πÄ‡∏ä‡πà‡∏ô "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥") ‚Üí ‡∏ï‡πâ‡∏≠‡∏á acknowledge + ‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠
 * 
 * ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å:
 * - acknowledge ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏π‡∏î
 * - ‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠ 1 ‡∏à‡∏∏‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
 * - ‡πÑ‡∏°‡πà‡∏°‡∏µ bullet
 * - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≤‡∏¢
 * - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£
 * - ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á
 */
export function templateAfterNosePreference(state: ConversationState): string {
  const style = state.preference?.style || "";
  const tone = state.tone || "short"; // default = short
  
  // ‚úÖ Tone Check: ‡∏ñ‡πâ‡∏≤ tone = short ‚Üí ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß / ‡πÑ‡∏°‡πà‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
  if (tone === "short") {
    return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä`;
  }
  
  // Acknowledge + ‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠ (‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ bullet)
  // üü° ‡πÇ‡∏´‡∏°‡∏î 2: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏≤‡∏° ‚Üí ‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ + ‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ö‡∏≤ ‡πÜ
  if (style === "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥") {
    return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÑ‡∏´‡∏ô‡∏Ç‡∏≠‡∏á‡∏à‡∏°‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞`;
  } else if (style === "‡πÇ‡∏î‡πà‡∏á" || style === "‡∏õ‡∏•‡∏≤‡∏¢‡∏û‡∏∏‡πà‡∏á") {
    return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÑ‡∏´‡∏ô‡∏Ç‡∏≠‡∏á‡∏à‡∏°‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞`;
  } else if (style === "‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ") {
    return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÑ‡∏´‡∏ô‡∏Ç‡∏≠‡∏á‡∏à‡∏°‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞`;
  } else {
    return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÑ‡∏´‡∏ô‡∏Ç‡∏≠‡∏á‡∏à‡∏°‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞`;
  }
}

/**
 * Template 12c: ‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏î‡πâ style ‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏î‡∏¥‡∏° - ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ style ‡πÅ‡∏•‡πâ‡∏ß)
 * ‚úÖ Human First Rule: ‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
 * ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠: ‡∏°‡∏µ preference.style ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ preference.intensity
 * 
 * ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å:
 * - ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô
 * - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÅ‡∏û‡∏ó‡∏¢‡πå
 * - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô
 * - ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡πà‡∏≠
 */
export function templateNoseStyleFollowup(state: ConversationState): string {
  const style = state.preference?.style || "";
  const tone = state.tone || "short"; // default = short
  
  // ‚úÖ Tone Check: ‡∏ñ‡πâ‡∏≤ tone = short ‚Üí ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß / ‡πÑ‡∏°‡πà‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
  if (tone === "short") {
    return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä`;
  }
  
  // ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô‡∏ï‡∏≤‡∏° style ‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ö‡∏≠‡∏Å (‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ bullet)
  let responseText = `‡πÇ‡∏≠‡πÄ‡∏Ñ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä`;
  
  if (style === "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥") {
    responseText += `\n‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÄ‡∏≠‡∏≤‡∏•‡∏∞‡∏°‡∏∏‡∏ô ‡πÜ ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏±‡∏ô‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á üíï`;
  } else if (style === "‡πÇ‡∏î‡πà‡∏á" || style === "‡∏õ‡∏•‡∏≤‡∏¢‡∏û‡∏∏‡πà‡∏á") {
    responseText += `\n‡πÅ‡∏ô‡∏ß‡πÇ‡∏î‡πà‡∏á‡∏™‡∏ß‡∏¢‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏±‡∏ô‡∏ä‡∏±‡∏î‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏≠‡∏≤‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÜ ‡∏î‡∏µ‡∏Ñ‡∏∞ üíï`;
  } else if (style === "‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ") {
    responseText += `\n‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏±‡∏ô‡∏ä‡∏±‡∏î‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏≠‡∏≤‡∏•‡∏∞‡∏°‡∏∏‡∏ô ‡πÜ ‡∏î‡∏µ‡∏Ñ‡∏∞ üíï`;
  } else {
    responseText += `\n‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ ‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏±‡∏ô‡∏ä‡∏±‡∏î‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏≠‡∏≤‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÜ ‡∏î‡∏µ‡∏Ñ‡∏∞ üíï`;
  }
  
  return responseText;
}

/**
 * Template 12b: ‡∏ñ‡∏≤‡∏° preference ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå/‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå
 * ‚úÖ Human First Rule: ‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
 */
export function templateAskFillerBotoxPreference(): string {
  return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏Ç‡∏≠‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞  

‡πÄ‡∏ä‡πà‡∏ô  
‚Ä¢ ‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥  
‚Ä¢ ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô  
‚Ä¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞  

‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡πà‡∏∞ üíï`;
}

/**
 * Template 12c: ‡∏ñ‡∏≤‡∏° preference ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏µ‡∏ï‡πÄ‡∏°‡∏ô‡∏ï‡πå/‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå
 * ‚úÖ Human First Rule: ‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
 */
export function templateAskTreatmentPreference(): string {
  return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏Ç‡∏≠‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ú‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞  

‡πÄ‡∏ä‡πà‡∏ô  
‚Ä¢ ‡∏ù‡πâ‡∏≤ ‡∏Å‡∏£‡∏∞  
‚Ä¢ ‡∏£‡∏π‡∏Ç‡∏∏‡∏°‡∏Ç‡∏ô‡∏Å‡∏ß‡πâ‡∏≤‡∏á  
‚Ä¢ ‡∏™‡∏¥‡∏ß  
‚Ä¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞  

‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡πà‡∏∞ üíï`;
}

/**
 * Template 13: ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏±‡πâ‡∏ô (Response Length Guard)
 * ‚úÖ Human First Rule: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏±‡πâ‡∏ô ‚Üí ‡∏ö‡∏≠‡∏ó‡∏™‡∏±‡πâ‡∏ô
 * ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1-3 ‡∏Ñ‡∏≥ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ preference.style ‡πÅ‡∏•‡πâ‡∏ß
 * 
 * ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å:
 * - ‡∏´‡πâ‡∏≤‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏ä‡∏¥‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
 * - ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡πÇ‡∏ó‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ
 * - ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ "‡∏£‡∏±‡∏ö + ‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏±‡πâ‡∏ô ‡πÜ" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
 * - ‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ, ‡∏ß‡∏±‡∏™‡∏î‡∏∏, ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô, ‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£
 * - ‚úÖ ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà ‡∏£‡∏±‡∏ö, ‡∏Ñ‡∏∏‡∏¢, ‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠
 */
export function templateShortHumanFollowup(state: ConversationState, userMessage: string): string {
  const style = state.preference?.style || "";
  const lower = userMessage.toLowerCase().trim();
  
  // Detect style ‡∏à‡∏≤‡∏Å user message ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô preference
  let detectedStyle = style;
  if (!detectedStyle) {
    if (/‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥/.test(lower)) detectedStyle = "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥";
    else if (/‡πÇ‡∏î‡πà‡∏á|‡∏û‡∏∏‡πà‡∏á/.test(lower)) detectedStyle = "‡πÇ‡∏î‡πà‡∏á";
    else if (/‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ|‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ/.test(lower)) detectedStyle = "‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ";
    else if (/‡∏™‡∏≤‡∏¢‡∏ù‡∏≠/.test(lower)) detectedStyle = "‡∏™‡∏≤‡∏¢‡∏ù‡∏≠";
  }
  
  // ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏ï‡∏≤‡∏° style
  let responseText = `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä`;
  
  if (detectedStyle === "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥") {
    responseText += `\n‡∏ó‡∏£‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Æ‡∏¥‡∏ï‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞`;
  } else if (detectedStyle === "‡πÇ‡∏î‡πà‡∏á" || detectedStyle === "‡∏õ‡∏•‡∏≤‡∏¢‡∏û‡∏∏‡πà‡∏á") {
    responseText += `\n‡πÅ‡∏ô‡∏ß‡πÇ‡∏î‡πà‡∏á‡∏™‡∏ß‡∏¢‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞`;
  } else if (detectedStyle === "‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ") {
    responseText += `\n‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞`;
  } else {
    responseText += `\n‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞`;
  }
  
  // ‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏±‡πâ‡∏ô ‡πÜ (1 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
  responseText += `\n\n‡∏Ç‡∏≠‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏±‡∏ô‡∏ä‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏≠‡∏≤‡πÄ‡∏ö‡∏≤ ‡πÜ ‡∏î‡∏µ‡∏Ñ‡∏∞ üíï`;
  
  return responseText;
}

/**
 * Template 6: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏≠‡∏á (‡πÑ‡∏°‡πà‡∏°‡∏µ service ‡∏´‡∏£‡∏∑‡∏≠ area)
 */
export function templateBookingNotReady(state: ConversationState): string {
  if (!state.service) {
    return `‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏Ç‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏ß‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏ô ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏à‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏∞ üòä`;
  }
  if (!state.area) {
    const serviceName = state.service === "filler" ? "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå" 
      : state.service === "rejuran" ? "‡∏£‡∏µ‡∏à‡∏π‡∏£‡∏±‡∏ô"
      : state.service === "botox" ? "‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå"
      : state.service === "laser" ? "‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå"
      : String(state.service);
    return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä ‡∏™‡∏ô‡πÉ‡∏à‡∏à‡∏≠‡∏á${serviceName}‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞  
‡∏Ç‡∏≠‡∏ó‡∏£‡∏≤‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏ó‡∏≥‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞ ‚ú®`;
  }
  return templateServiceSelected(state);
}

/**
 * ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å template ‡∏ï‡∏≤‡∏° state ‡πÅ‡∏•‡∏∞ intent
 * üß† FINAL FLOW: Select template ‡∏ï‡∏≤‡∏° intent (‡πÑ‡∏°‡πà‡∏°‡∏±‡πà‡∏ß)
 */
export function selectTemplate(
  state: ConversationState,
  userMessage: string,
  isFollowUp: boolean
): string {
  // 7Ô∏è‚É£ general_chat / short follow-up
  // ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ state ‚Üí treat ‡πÄ‡∏õ‡πá‡∏ô continuation
  // ‚ùå ‡∏´‡πâ‡∏≤‡∏° reset
  // ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏•‡∏≠‡∏¢ ‡πÜ
  if (isFollowUp && state.stage !== "greeting") {
    return templateShortFollowUp(userMessage, state);
  }

  // 6Ô∏è‚É£ medical_question / aftercare_question
  if (state.stage === "medical") {
    return templateMedical();
  }

  if (state.stage === "waiting_admin") {
    return ""; // Bot ‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏π‡∏î
  }

  // ‚úÖ 4Ô∏è‚É£ Template Guard: ‡∏Å‡∏±‡∏ô AI ‡πÄ‡∏î‡∏≤‡πÅ‡∏ó‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)
  // ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ template ‚Üí ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ AI
  // AI ‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à

  // ‚úÖ Human First Rule: ‡∏ñ‡∏≤‡∏° preference ‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
  // ‡∏Å‡∏é‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ preference ‚Üí ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà AI = ‡∏ñ‡∏≤‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  // ‚ùå ‡∏´‡πâ‡∏≤‡∏° auto ‡πÄ‡∏Ç‡πâ‡∏≤ templateKnowledgeSurgery / templateExplainProcedure
  // ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
  // 
  // üî• LOGIC LOCK: ‡πÄ‡∏ö‡∏£‡∏Å AI ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏•‡∏∏‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô AI
  // ‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ knowledge ‡∏û‡∏£‡πâ‡∏≠‡∏° ‚Üí ‡∏Å‡πá‡∏´‡πâ‡∏≤‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
  // ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô "‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ô" ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
  //
  // ‚úÖ ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å - ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏•‡∏±‡∏ö):
  // Step 1: ‡πÄ‡∏ä‡πá‡∏Å service + area ‡∏Å‡πà‡∏≠‡∏ô
  // Step 2: ‡πÄ‡∏ä‡πá‡∏Å preference (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‚Üí ‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô)
  // Step 3: ‡πÄ‡∏ä‡πá‡∏Å tone (‡πÉ‡∏ô template functions ‡πÄ‡∏≠‡∏á)
  // Step 4: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å template
  // ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ä‡πá‡∏Å "‡πÇ‡∏´‡∏°‡∏î" ‡∏Å‡πà‡∏≠‡∏ô "preference" ‚Üí AI ‡∏à‡∏∞‡∏´‡∏•‡∏∏‡∏î‡πÑ‡∏õ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
  
  // üîπ ‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°: ‡∏ñ‡∏≤‡∏° preference ‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
  // üü¢ ‡πÇ‡∏´‡∏°‡∏î 1: ‡πÅ‡∏Ñ‡πà‡∏ó‡∏±‡∏Å / ‡∏™‡∏ô‡πÉ‡∏à ‚Üí ‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÜ 1 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
  // ‚úÖ ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤: ‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà ‚Üí ‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô, ‡∏Ñ‡∏∏‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏Ñ‡πà‡∏≠‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
  
  // ‚úÖ Step 1: ‡πÄ‡∏ä‡πá‡∏Å service + area ‡∏Å‡πà‡∏≠‡∏ô
  // ‚úÖ Step 2: ‡πÄ‡∏ä‡πá‡∏Å preference
  // ‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏°‡∏π‡∏Å
  if (
    state.service === "surgery" &&
    state.area === "nose" &&
    !state.preference?.style &&
    state.intent !== "service_information" // üîµ ‡πÇ‡∏´‡∏°‡∏î 3: ‡∏ñ‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á ‚Üí ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
  ) {
    // ‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏°‡∏π‡∏Å ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ preference ‡πÄ‡∏•‡∏¢ (‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà)
    if (state.recentMessages.length <= 1) {
      return templateAskNosePreferenceHuman();
    }
    // ‡∏Ñ‡∏∏‡∏¢‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡πà‡∏≠‡∏¢‡∏ñ‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
    return templateAskNosePreference();
  }
  
  // ‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏≤
  if (
    state.service === "surgery" &&
    state.area === "eye" &&
    !state.preference?.style &&
    state.intent !== "service_information"
  ) {
    if (state.recentMessages.length <= 1) {
      return templateAskEyePreferenceHuman();
    }
    return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏Ç‡∏≠‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏™‡∏ô‡πÉ‡∏à‡∏ï‡∏≤‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞  
‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å ‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏Ñ‡∏∞`;
  }
  
  // ‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å, ‡∏•‡∏≥‡∏ï‡∏±‡∏ß, ‡∏Ø‡∏•‡∏Ø)
  if (
    state.service === "surgery" &&
    state.area &&
    state.area !== "nose" &&
    state.area !== "eye" &&
    !state.preference?.goal &&
    state.intent !== "service_information"
  ) {
    return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏Ç‡∏≠‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÑ‡∏´‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞`;
  }
  
  // üîë SHORT REPLY LOCK (Response Length Guard)
  // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏±‡πâ‡∏ô = ‡∏ö‡∏≠‡∏ó‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô
  // ‡∏ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1-3 ‡∏Ñ‡∏≥ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ preference.style ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÉ‡∏ä‡πâ template ‡∏™‡∏±‡πâ‡∏ô ‡πÜ
  if (
    state.service === "surgery" &&
    state.area === "nose" &&
    (state.preference?.style || /‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥|‡πÇ‡∏î‡πà‡∏á|‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ|‡∏™‡∏≤‡∏¢‡∏ù‡∏≠/.test(userMessage.toLowerCase())) &&
    userMessage.trim().length <= 10 && // ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 1-3 ‡∏Ñ‡∏≥)
    state.intent !== "service_information"
  ) {
    return templateShortHumanFollowup(state, userMessage);
  }
  
  // üîπ ‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏°‡∏π‡∏Å: ‡∏°‡∏µ style ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ intensity ‚Üí ‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠
  if (
    state.service === "surgery" &&
    state.area === "nose" &&
    state.preference?.style &&
    !state.preference?.intensity &&
    state.intent !== "service_information"
  ) {
    return templateNoseStyleFollowup(state);
  }
  
  // üîπ ‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå/‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå: ‡∏ñ‡∏≤‡∏° intensity, goal
  if (
    (state.service === "filler" || state.service === "botox") &&
    state.area &&
    !state.preference?.intensity &&
    !state.preference?.goal &&
    (state.stage === "service_selected" || state.stage === "pricing") &&
    state.intent !== "service_information"
  ) {
    return templateAskFillerBotoxPreference();
  }
  
  // üîπ ‡∏ó‡∏£‡∏µ‡∏ï‡πÄ‡∏°‡∏ô‡∏ï‡πå/‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå: ‡∏ñ‡∏≤‡∏° concern, intensity, goal
  if (
    (state.service === "laser" || state.service === "skin" || state.service === "rejuran") &&
    !state.preference?.concern &&
    !state.preference?.intensity &&
    (state.stage === "service_selected" || state.stage === "pricing") &&
    state.intent !== "service_information"
  ) {
    return templateAskTreatmentPreference();
  }

  // 4Ô∏è‚É£ availability_check
  // üî• ‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏à
  // ‚ùå templatePricing (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î)
  // ‚ùå ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤
  // ‚úÖ templateAvailability ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  if (state.intent === "availability_check") {
    return templateAvailability(state);
  }

  // price_inquiry ‚Äî ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ service ‚Üí ‡πÉ‡∏ä‡πâ exploring (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏î‡∏≤)
  if (state.intent === "price_inquiry" && !state.service) {
    return templateExploring(state);
  }

  // refinement ‚Äî ‡πÉ‡∏ä‡πâ templateRefinement
  // (refinement ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ô pipeline ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° guard ‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)
  if ((state.intent as string) === "refinement" || (state.service && state.area && /‡πÇ‡∏î‡πà‡∏á|‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥|‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ/.test(userMessage.toLowerCase()))) {
    return templateRefinement(state, userMessage);
  }

  // 2Ô∏è‚É£ service_information
  // ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ service ‚Üí ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ service ‡∏ô‡∏±‡πâ‡∏ô
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ service ‚Üí ‡πÅ‡∏™‡∏î‡∏á option ‡πÅ‡∏ö‡∏ö‡∏Å‡∏ß‡πâ‡∏≤‡∏á
  // ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏≤‡∏¢
  // ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏π‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤
  if (state.intent === "service_information") {
    return templateServiceInformation(state);
  }

  // üîß comparison_inquiry ‚Äî ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
  // ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡πÑ‡∏°‡πà‡∏ü‡∏±‡∏ô‡∏ò‡∏á ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ "‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ú‡∏¥‡∏ß / ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô"
  if (state.intent === "comparison_inquiry") {
    return templateComparison(state, userMessage);
  }

  // üîß hesitation ‚Äî ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏á‡πÄ‡∏•/‡∏Å‡∏•‡∏±‡∏ß
  // ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå normalize ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ß ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡πâ‡∏ô ‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏∏‡∏¢‡∏ï‡πà‡∏≠ ‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏Ç‡∏≤‡∏¢
  if (state.intent === "hesitation") {
    return templateHesitation(state, userMessage);
  }

  // 3Ô∏è‚É£ promotion_inquiry / price_inquiry
  // ‚ö†Ô∏è Pricing/Promotion inquiry: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ service ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÇ‡∏õ‡∏£
  // Guard: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ service ‚Üí ‡πÉ‡∏ä‡πâ exploring (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏î‡∏≤)
  if (state.stage === "pricing" && state.service) {
    return templatePricing(state);
  }
  
  // ‡∏ñ‡πâ‡∏≤ stage = pricing ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ service ‚Üí exploring (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏∏‡∏î other)
  if (state.stage === "pricing" && !state.service) {
    return templateExploring(state);
  }

  // 5Ô∏è‚É£ booking_request
  // ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ service ‚Üí ‡∏ñ‡∏≤‡∏° service
  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ service ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô ‚Üí ‡∏Ç‡∏≠‡∏ß‡∏±‡∏ô
  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö ‚Üí confirm
  if (state.stage === "booking") {
    if (!state.service || !state.area) {
      return templateBookingNotReady(state);
    }
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÉ‡∏ä‡πâ templatePricing ‡∏´‡∏£‡∏∑‡∏≠ templateAvailability ‡∏ï‡∏≤‡∏° context
    return templatePricing(state);
  }

  if (state.stage === "service_selected" && state.service) {
    // üîß FIX 2: Guard ‡∏Å‡∏±‡∏ô template ‡∏ú‡∏¥‡∏î ‚Äî ‡∏ñ‡πâ‡∏≤ service + area ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÉ‡∏ä‡πâ templatePricing
    // ‚úÖ ‡∏ñ‡πâ‡∏≤ service + area ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÉ‡∏ä‡πâ templatePricing ‡πÄ‡∏™‡∏°‡∏≠
    // ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ templateServiceSelected ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ area ‡πÅ‡∏•‡πâ‡∏ß
    if (state.area && state.area !== "unknown") {
      // ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á service ‡πÅ‡∏•‡∏∞ area ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÉ‡∏ä‡πâ templatePricing
      return templatePricing({
        ...state,
        stage: "pricing",
      });
    }
    
    // üß© FIX 4: Guard ‡∏Å‡∏±‡∏ô template ‡∏ú‡∏¥‡∏î ‚Äî ‡∏ñ‡πâ‡∏≤ service ‡∏°‡∏µ FIXED AREA ‚Üí ‡πÉ‡∏ä‡πâ templatePricing
    const fixedArea = hasFixedArea(state.service);
    if (fixedArea) {
      // ‡∏°‡∏µ FIXED AREA ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏° area ‚Üí ‡πÉ‡∏ä‡πâ templatePricing
      return templatePricing({
        ...state,
        area: fixedArea,
        stage: "pricing",
      });
    }
    return templateServiceSelected(state);
  }

  // ‚úÖ FIX 3: Route template ‡∏ï‡∏≤‡∏° "‡∏´‡∏°‡∏ß‡∏î service" ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà intent ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ service ‚Üí route ‡∏ï‡∏≤‡∏° keyword ‡πÉ‡∏ô userMessage
  if (!state.service) {
    const lower = userMessage.toLowerCase();
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ keyword ‡∏ó‡∏µ‡πà‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏° ‚Üí ‡πÉ‡∏ä‡πâ templateExploringSurgery
    if (/‡∏à‡∏°‡∏π‡∏Å|‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏°‡∏π‡∏Å|‡∏ó‡∏≥‡∏à‡∏°‡∏π‡∏Å|‡πÅ‡∏Å‡πâ‡∏à‡∏°‡∏π‡∏Å|‡∏ï‡∏≤‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô|‡∏Ñ‡∏≤‡∏á|‡∏Å‡∏£‡∏≤‡∏°|‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°/.test(lower)) {
      return templateExploringSurgery(state);
    }
    // Default: ‡πÉ‡∏ä‡πâ templateExploringSkin (‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏ß)
    return templateExploringSkin(state);
  }
  
  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ service ‡πÅ‡∏•‡πâ‡∏ß ‚Üí route ‡∏ï‡∏≤‡∏° service
  if (state.service === "surgery") {
    return templateExploringSurgery(state);
  }
  
  // exploring ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ service (fallback)
  return templateExploring(state);
}
