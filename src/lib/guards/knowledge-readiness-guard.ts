/**
 * üîí Knowledge Readiness Guard ‚Äî ‡∏Å‡∏±‡∏ô AI ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÅ‡∏ó‡∏ô‡∏ñ‡πâ‡∏≤ knowledge ‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á
 * 
 * ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:
 * - AI ‡πÑ‡∏°‡πà improvise
 * - ‡∏î‡∏π‡∏ã‡∏∑‡πà‡∏≠ / ‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û
 * - ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ß‡πà‡∏≤ AI ‡∏°‡∏±‡πà‡∏ß
 * 
 * ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ "‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢"
 */
import type { ConversationState } from "../agents/conversation-state";
import { getServiceKnowledge } from "../agents/knowledge-base";

/**
 * Knowledge Readiness Guard: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 * ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‚Üí return ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
 * ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‚Üí return null (‡πÉ‡∏´‡πâ pipeline ‡πÑ‡∏õ‡∏ï‡πà‡∏≠)
 */
export function knowledgeReadyGuard(
  state: ConversationState
): string | null {
  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ service ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ
  if (!state.service) {
    return null;
  }

  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ knowledge ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö service ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const knowledge = getServiceKnowledge(state.service);
  
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ knowledge ‚Üí return ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
  if (!knowledge || !knowledge.description) {
    const serviceName = state.service === "surgery" ? "‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°"
      : state.service === "filler" ? "‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå"
      : state.service === "rejuran" ? "‡∏£‡∏µ‡∏à‡∏π‡∏£‡∏±‡∏ô"
      : state.service === "botox" ? "‡πÇ‡∏ö‡∏ó‡πá‡∏≠‡∏Å‡∏ã‡πå"
      : state.service === "laser" ? "‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå"
      : String(state.service);
    
    return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä  
‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£${serviceName} ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Ç‡∏≠‡πÄ‡∏ä‡πá‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞  
‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ñ‡πà‡∏∞ üíï`;
  }

  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ knowledge ‚Üí return null (‡πÉ‡∏´‡πâ pipeline ‡πÑ‡∏õ‡∏ï‡πà‡∏≠)
  return null;
}
