/**
 * ЁЯФТ Surgery Flow Lock тАФ р╕Бр╕▒р╕Щр╕ир╕▒р╕ер╕вр╕Бр╕гр╕гр╕бр╕лр╕ер╕╕р╕Фр╣Др╕Ы pricing/р╣Вр╕Ыр╕гр╣Ар╕гр╣Зр╕з
 * 
 * р╕лр╕ер╕▒р╕Бр╕Др╕┤р╕Ф:
 * - skin тЖТ р╕гр╕▓р╕Др╕▓р╣Ар╕Ыр╣Зр╕Щр╕Кр╣Ир╕зр╕Зр╣Др╕Фр╣Й
 * - surgery тЖТ р╕лр╣Йр╕▓р╕бр╕гр╕▓р╕Др╕▓ р╕Ир╕Щр╕Бр╕зр╣Ир╕▓р╕Ир╕░ consult
 * 
 * р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М:
 * - AI р╕Фр╕╣р╣Ар╕лр╕бр╕╖р╕нр╕Щр╕Др╕ер╕┤р╕Щр╕┤р╕Бр╕Ир╕гр╕┤р╕Зр╕бр╕▓р╕Б
 * - р╕ер╕Фр╕Фр╕гр╕▓р╕бр╣Ир╕▓р╣Ар╕гр╕╖р╣Ир╕нр╕Зр╕гр╕▓р╕Др╕▓
 * - р╕Эр╣Ир╕▓р╕вр╕Вр╕▓р╕вр╕Кр╕нр╕Ър╕бр╕▓р╕Б
 */
import type { ConversationState } from "../agents/conversation-state";
import type { IntentType } from "../agents/types";

/**
 * Surgery Flow Guard: р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕ир╕▒р╕ер╕вр╕Бр╕гр╕гр╕бр╕Др╕зр╕гр╣Гр╕лр╣Йр╕гр╕▓р╕Др╕▓/р╣Вр╕Ыр╕гр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
 * р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕Др╕зр╕г тЖТ return р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕╡р╣Ир╣Ар╕лр╕бр╕▓р╕░р╕кр╕б
 * р╕Цр╣Йр╕▓р╕Др╕зр╕г тЖТ return null (р╣Гр╕лр╣Й pipeline р╣Др╕Ыр╕Хр╣Ир╕н)
 */
export function surgeryFlowGuard(
  state: ConversationState,
  intent: IntentType
): string | null {
  // р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╣Гр╕Кр╣И surgery тЖТ р╣Др╕бр╣Ир╕Хр╣Йр╕нр╕Зр╣Ар╕Кр╣Зр╕Д
  if (state.service !== "surgery") {
    return null;
  }

  // р╕Цр╣Йр╕▓р╣Ар╕Ыр╣Зр╕Щ price_inquiry р╕лр╕гр╕╖р╕н promotion_inquiry тЖТ р╕лр╣Йр╕▓р╕бр╣Гр╕лр╣Йр╕гр╕▓р╕Др╕▓
  // р╕ир╕▒р╕ер╕вр╕Бр╕гр╕гр╕бр╕Хр╣Йр╕нр╕Зр╣Гр╕лр╣Йр╕Др╕╕р╕Ур╕лр╕бр╕нр╕Ыр╕гр╕░р╣Ар╕бр╕┤р╕Щр╕Бр╣Ир╕нр╕Щр╣Ар╕кр╕бр╕н
  if (
    ["price_inquiry", "promotion_inquiry"].includes(intent) &&
    state.stage !== "booking" // р╕Цр╣Йр╕▓р╕Юр╕гр╣Йр╕нр╕бр╕Ир╕нр╕Зр╣Бр╕ер╣Йр╕з тЖТ р╣Гр╕лр╣Йр╣Др╕Ыр╕Хр╣Ир╕нр╣Др╕Фр╣Й
  ) {
    // р╕Цр╣Йр╕▓р╣Ар╕Ыр╣Зр╕Щ surgery + nose тЖТ р╣Бр╕кр╕Фр╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Ар╕Йр╕Юр╕▓р╕░
    if (state.area === "nose") {
      return `р╣Др╕Фр╣Йр╣Ар╕ер╕вр╕Др╣Ир╕░ ЁЯШК  
р╕Бр╕▓р╕гр╣Ар╕кр╕гр╕┤р╕бр╕Ир╕бр╕╣р╕Бр╕Ир╕░р╕Хр╣Йр╕нр╕Зр╣Гр╕лр╣Йр╕Др╕╕р╕Ур╕лр╕бр╕нр╕Ыр╕гр╕░р╣Ар╕бр╕┤р╕Щр╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╕Ир╕бр╕╣р╕Бр╕Ир╕гр╕┤р╕З р╣Ж р╕Бр╣Ир╕нр╕Щр╕Щр╕░р╕Др╕░  
р╕гр╕▓р╕Др╕▓р╕Ир╕░р╕Вр╕╢р╣Йр╕Щр╕нр╕вр╕╣р╣Ир╕Бр╕▒р╕Ър╣Ар╕Чр╕Др╕Щр╕┤р╕Др╣Бр╕ер╕░р╕зр╕▒р╕кр╕Фр╕╕р╕Чр╕╡р╣Ир╣Гр╕Кр╣Й  

р╣Бр╕нр╕Фр╕бр╕┤р╕Щр╕Кр╣Ир╕зр╕вр╕Щр╕▒р╕Фр╕Др╕┤р╕зр╕Ыр╕гр╕╢р╕Бр╕йр╕▓р╕Др╕╕р╕Ур╕лр╕бр╕нр╣Гр╕лр╣Йр╣Др╕Фр╣Йр╣Ар╕ер╕вр╕Др╣Ир╕░ ЁЯТХ`;
    }
    
    // р╕ир╕▒р╕ер╕вр╕Бр╕гр╕гр╕бр╕нр╕╖р╣Ир╕Щ р╣Ж
    return `р╣Др╕Фр╣Йр╣Ар╕ер╕вр╕Др╣Ир╕░ ЁЯШК  
р╕ир╕▒р╕ер╕вр╕Бр╕гр╕гр╕бр╕Ир╕░р╕Хр╣Йр╕нр╕Зр╣Гр╕лр╣Йр╕Др╕╕р╕Ур╕лр╕бр╕нр╕Ыр╕гр╕░р╣Ар╕бр╕┤р╕Щр╕Бр╣Ир╕нр╕Щр╕Щр╕░р╕Др╕░  
р╕гр╕▓р╕Др╕▓р╕Ир╕░р╕Вр╕╢р╣Йр╕Щр╕нр╕вр╕╣р╣Ир╕Бр╕▒р╕Ър╣Ар╕Чр╕Др╕Щр╕┤р╕Др╣Бр╕ер╕░р╕зр╕▒р╕кр╕Фр╕╕р╕Чр╕╡р╣Ир╣Гр╕Кр╣Й  

р╣Бр╕нр╕Фр╕бр╕┤р╕Щр╕Кр╣Ир╕зр╕вр╕Щр╕▒р╕Фр╕Др╕┤р╕зр╕Ыр╕гр╕╢р╕Бр╕йр╕▓р╕Др╕╕р╕Ур╕лр╕бр╕нр╣Гр╕лр╣Йр╣Др╕Фр╣Йр╣Ар╕ер╕вр╕Др╣Ир╕░ ЁЯТХ`;
  }

  // р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╣Гр╕Кр╣И price/promotion inquiry тЖТ р╣Гр╕лр╣Йр╣Др╕Ыр╕Хр╣Ир╕нр╣Др╕Фр╣Й
  return null;
}
