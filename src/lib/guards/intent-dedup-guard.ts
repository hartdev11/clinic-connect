import type { ConversationState } from "../agents/conversation-state";
import type { IntentType } from "../agents/types";

/**
 * Intent Deduplication Guard
 * 
 * üîë ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
 * 
 * ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å:
 * ‚ùå ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà ‚â† state ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏™‡∏°‡∏≠
 * ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° ‚Üí ‡∏´‡πâ‡∏≤‡∏° reset flow
 * 
 * ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
 * - "‡∏™‡∏ô‡πÉ‡∏à‡∏ó‡∏≥‡∏à‡∏°‡∏π‡∏Å" ‚Üí service = surgery, area = nose
 * - "‡∏≠‡∏¢‡∏≤‡∏Å‡∏ó‡∏≥‡∏à‡∏°‡∏π‡∏Å" ‚Üí ‡∏ñ‡πâ‡∏≤ intent, service, area ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‚Üí ‡∏´‡πâ‡∏≤‡∏°‡∏ñ‡∏≤‡∏°‡∏ã‡πâ‡∏≥
 * 
 * @param prevState State ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
 * @param intent Intent ‡∏ó‡∏µ‡πà detect ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
 * @param nextState State ‡∏´‡∏•‡∏±‡∏á update
 * @returns true ‡∏ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥ (‡∏´‡πâ‡∏≤‡∏°‡∏ñ‡∏≤‡∏°‡∏ã‡πâ‡∏≥), false ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ (‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ)
 */
export function intentDedupGuard(
  prevState: ConversationState,
  intent: IntentType,
  nextState: ConversationState
): boolean {
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ state ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‚Üí ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ (‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ)
  if (!prevState.service && !prevState.area) {
    return false;
  }

  // ‡∏ñ‡πâ‡∏≤ intent ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‚Üí ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ (‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ)
  if (prevState.intent !== intent) {
    return false;
  }

  // ‡∏ñ‡πâ‡∏≤ service ‡∏´‡∏£‡∏∑‡∏≠ area ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‚Üí ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ (‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ)
  if (
    prevState.service !== nextState.service ||
    prevState.area !== nextState.area
  ) {
    return false;
  }

  // ‡∏ñ‡πâ‡∏≤ stage ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‚Üí ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ (‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ)
  // ‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏≤‡∏Å exploring ‚Üí service_selected ‚Üí ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
  if (prevState.stage !== nextState.stage) {
    return false;
  }

  // ‡∏ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‚Üí ‡∏ã‡πâ‡∏≥ (‡∏´‡πâ‡∏≤‡∏°‡∏ñ‡∏≤‡∏°‡∏ã‡πâ‡∏≥)
  // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
  // ‡πÄ‡∏ä‡πà‡∏ô "‡∏™‡∏ô‡πÉ‡∏à‡∏ó‡∏≥‡∏à‡∏°‡∏π‡∏Å" ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå "‡∏≠‡∏¢‡∏≤‡∏Å‡∏ó‡∏≥‡∏à‡∏°‡∏π‡∏Å" ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
  return true;
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á reply ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà detect ‡∏ã‡πâ‡∏≥
 * ‡πÑ‡∏°‡πà‡∏ñ‡∏≤‡∏°‡∏ã‡πâ‡∏≥ ‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à
 */
export function composeDedupReply(state: ConversationState): string {
  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ preference.style ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏ï‡∏≠‡∏ö‡∏ï‡∏≤‡∏° preference
  if (state.service === "surgery" && state.area === "nose" && state.preference?.style) {
    const style = state.preference.style;
    if (style === "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥") {
      return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä ‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ‡∏î‡∏µ‡∏Ñ‡∏∞`;
    } else if (style === "‡πÇ‡∏î‡πà‡∏á" || style === "‡∏õ‡∏•‡∏≤‡∏¢‡∏û‡∏∏‡πà‡∏á") {
      return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä ‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏±‡∏ô‡∏ä‡∏±‡∏î‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞`;
    } else if (style === "‡∏™‡∏≤‡∏¢‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ") {
      return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä ‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏î‡∏µ‡∏Ñ‡∏∞`;
    }
  }

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ preference ‚Üí ‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÜ
  if (state.service === "surgery" && state.area === "nose") {
    return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä ‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ‡∏î‡∏µ‡∏Ñ‡∏∞`;
  }

  // Default: ‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡πÜ
  return `‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ üòä`;
}
