# E1.2 — Firestore Rules & Composite Indexes

## 1. Firestore Security Rules

### organizations
- **read, write**: เฉพาะเมื่อ `request.auth.token.org_id == orgId` (doc id)
- ป้องกัน cross-org: user จาก org A ไม่สามารถอ่าน/เขียน organizations/org_B ได้

### branches
- **read**: เฉพาะเมื่อ `resource.data.org_id == request.auth.token.org_id`
- **create**: เฉพาะเมื่อ `request.resource.data.org_id == request.auth.token.org_id`
- **update, delete**: เฉพาะเมื่อ `resource.data.org_id == request.auth.token.org_id` และ update ห้ามเปลี่ยน `org_id`
- ป้องกัน cross-org: user จาก org A ไม่สามารถเข้าถึง branches ที่มี org_id = B ได้

### collections อื่น
- **read, write**: deny ทั้งหมด (ใช้ Admin SDK server-side เท่านั้น)

---

## 2. ตัวอย่าง Rule ที่บล็อก Cross-Org Access

### กรณี: User จาก org_abc พยายามอ่าน organizations/org_xyz
```
request.auth.token.org_id = "org_abc"
orgId (path) = "org_xyz"
→ org_abc != org_xyz → DENY
```

### กรณี: User จาก org_abc พยายามอ่าน branches ที่มี org_id = org_xyz
```
request.auth.token.org_id = "org_abc"
resource.data.org_id = "org_xyz"
→ org_abc != org_xyz → DENY
```

### กรณี: User จาก org_abc พยายาม create branch ด้วย org_id = org_xyz
```
request.auth.token.org_id = "org_abc"
request.resource.data.org_id = "org_xyz"
→ org_abc != org_xyz → DENY
```

### กรณี: User จาก org_abc พยายาม update branch ให้เปลี่ยน org_id เป็น org_xyz
```
resource.data.org_id = "org_abc"
request.resource.data.org_id = "org_xyz"
→ org_abc != org_xyz → DENY (ห้ามเปลี่ยน org_id)
```

---

## 3. Composite Indexes (E1.2)

| Collection   | Fields                          | ใช้เมื่อ                                      |
|-------------|----------------------------------|-----------------------------------------------|
| branches    | org_id (ASC), createdAt (DESC)  | Query: list branches ของ org เรียงตามวันที่สร้าง |
| branches    | org_id (ASC), name (ASC)        | Query: list branches ของ org เรียงตามชื่อ      |
| organizations | plan (ASC), createdAt (DESC)  | Query: list orgs ตาม plan และวันที่สร้าง       |

---

## 4. E1.2 Definition of Done

- [ ] Firestore rules มี organizations และ branches ครบ
- [ ] organizations: ตรวจ org_id จาก token ตรงกับ doc id
- [ ] branches: read/create/update/delete ตรวจ org_id ครบ
- [ ] branches update: ห้ามเปลี่ยน org_id
- [ ] collections อื่นยัง deny client (catch-all)
- [ ] firestore.indexes.json มี branches (org_id + createdAt), branches (org_id + name), organizations (plan + createdAt)
- [ ] Deploy rules: `firebase deploy --only firestore:rules`
- [ ] Deploy indexes: `firebase deploy --only firestore:indexes`
