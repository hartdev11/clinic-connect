# E7.1–E7.8 — Checkout, Webhook & Proration

## Stripe

- `createCheckoutSession` — POST /api/clinic/checkout
- Webhook — POST /api/webhooks/stripe
- Idempotency — เก็บ stripe_events collection (event.id)

## Env

```
STRIPE_SECRET_KEY=sk_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_PRICE_PROFESSIONAL=price_...
STRIPE_PRICE_MULTI_BRANCH=price_...
STRIPE_PRICE_ENTERPRISE=price_...
NEXT_PUBLIC_APP_URL=https://...
```

## createCheckoutSession

POST /api/clinic/checkout  
Body: `{ plan: "professional"|"multi_branch"|"enterprise", successUrl?, cancelUrl? }`  
Response: `{ url, sessionId }`

## Webhook (idempotency)

1. Verify signature
2. Check stripe_events/{event.id} — ถ้ามีแล้ว → return 200
3. Handle event
4. Mark processed

Events: checkout.session.completed, customer.subscription.updated, customer.subscription.deleted

## stripe_events collection

| Field | Type |
|-------|------|
| id (doc) | event.id |
| processed_at | timestamp |

## Implementation

- `src/lib/stripe.ts` — getStripe, STRIPE_WEBHOOK_SECRET
- `src/app/api/clinic/checkout/route.ts` — createCheckoutSession (subscription mode)
- `src/app/api/webhooks/stripe/route.ts` — webhook handler + idempotency
- `src/app/api/clinic/subscription/route.ts` — GET subscription status (สำหรับ UI)
- `src/components/clinic/BillingSection.tsx` — Billing UI ใน Settings
- `subscriptions` collection — เพิ่ม `stripe_subscription_id` สำหรับ link กับ Stripe

## E7.5–E7.8 — Proration & Upgrade mid-cycle

- ใช้ Stripe proration (provider) — `proration_behavior: 'always_invoice'`
- Upgrade mid-cycle ได้ — มี subscription อยู่แล้ว → เรียก `subscriptions.update()` แทน Checkout
- `GET /api/clinic/checkout/preview?plan=...` — preview proration amount ก่อน upgrade
- Webhook `subscription.updated` — อัปเดต plan, max_branches, org
