# E1.4 — Data Access Layer Refactor (org_id / branch_id)

## 1. รายการไฟล์ที่แก้

- [x] `src/lib/clinic-data.ts` — เปลี่ยนทุก query เป็น org_id, เพิ่ม getOrgIdFromClinicId, getOrgProfile
- [x] `src/types/clinic.ts` — เพิ่ม org_id, branch_id ใน Booking, Customer, Transaction, Promotion; เพิ่ม OrgProfile
- [x] `src/types/organization.ts` — เพิ่ม phone, email
- [x] `src/app/api/clinic/me/route.ts`
- [x] `src/app/api/clinic/dashboard/route.ts`
- [x] `src/app/api/clinic/bookings/route.ts`
- [x] `src/app/api/clinic/customers/route.ts`
- [x] `src/app/api/clinic/finance/route.ts`
- [x] `src/app/api/clinic/promotions/route.ts`
- [x] `firestore.indexes.json` — เพิ่ม org_id composite indexes
- [x] `scripts/migrate-add-org-id-to-collections.ts` — migration เพิ่ม org_id ให้ child collections

## 2. ตัวอย่าง Code (ก่อน / หลัง)

### Query เดิม (clinicId)
```ts
db.collection("bookings").where("clinicId", "==", clinicId).orderBy("createdAt", "desc")
```

### Query ใหม่ (org_id)
```ts
db.collection("bookings").where("org_id", "==", orgId).orderBy("createdAt", "desc")
```

### Function signature
```ts
// เดิม
getBookings(clinicId: string, opts?)

// ใหม่
getBookings(orgId: string, opts?: { branchId?: string; limit?; startAfterId? })
```

### API flow
```ts
// session มี clinicId (legacy)
const orgId = await getOrgIdFromClinicId(session.clinicId);
if (!orgId) return 404;
const items = await getBookings(orgId, { limit: 20 });
```

## 3. Guardrails

- ❌ ห้ามใช้ clinicId ใน query ใหม่
- ❌ ห้ามแก้ Firestore rules
- ❌ ห้ามลบ clinics
- ✅ แก้เฉพาะ data access + types

## 4. Migration ลำดับ

1. รัน E1.3: `npm run migrate:clinics-to-orgs` (clinics → organizations + branches)
2. รัน E1.4: `npm run migrate:add-org-id:dry` (dry-run ก่อน)
3. รัน E1.4: `npm run migrate:add-org-id` (เพิ่ม org_id ให้ bookings, customers, transactions, promotions)
4. Deploy indexes: `firebase deploy --only firestore:indexes`

## 5. E1.4 Definition of Done

- [ ] ทุก Firestore query ใช้ org_id
- [ ] Branch-scoped data ใช้ branch_id อย่างถูกต้อง (opts.branchId)
- [ ] ไม่มี reference clinicId ใน data layer (ยกเว้น getOrgIdFromClinicId ที่รับ legacy)
- [ ] ระบบยังทำงานเหมือนเดิม (logic ไม่เปลี่ยน)
- [ ] Migration script รันเสร็จ และ indexes deploy แล้ว
