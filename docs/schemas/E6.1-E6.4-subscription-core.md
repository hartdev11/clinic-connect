# E6.1–E6.4 — Subscription Core

## Pricing per-branch

| Plan | max_branches |
|------|--------------|
| starter | 1 |
| professional | 3 |
| multi_branch | 10 |
| enterprise | 999 |

## subscriptions collection

| Field | Type | หมายเหตุ |
|-------|------|----------|
| org_id | string | FK → organizations |
| plan | OrgPlan | starter \| professional \| multi_branch \| enterprise |
| status | string | active \| past_due \| cancelled \| trialing |
| max_branches | number | โควตาสาขา (override จาก plan) |
| current_period_start | string (ISO) | |
| current_period_end | string (ISO) | |
| createdAt, updatedAt | timestamp | |

ถ้าไม่มี subscription record → ใช้ PLAN_MAX_BRANCHES[org.plan]

## enforceLimits(orgId, action)

- **action**: `"add_branch"` \| `"check"`
- **returns**: `{ allowed: boolean; reason?; currentBranches?; maxBranches?; plan? }`
- ตรวจ subscription หรือ org.plan ก่อนให้เพิ่มสาขา

## E6.9 — Fair Use

- **80%** → `warning: true` (แสดงแจ้งเตือนใน UI)
- **100%** → soft block (`allowed: false` พร้อมข้อความแนะนำอัปเกรด)
- **❌ ห้าม hard block** — คืน HTTP 403 + message ไม่ throw/crash

## API

- **POST** `/api/clinic/branches` — เพิ่มสาขา (เรียก enforceLimits ก่อน) — body: `{ name, address? }`
  - success: `{ id, name, warning?, usagePercent? }`
  - 403 (soft block): `{ error: "ถึงขีดจำกัด..." }`
