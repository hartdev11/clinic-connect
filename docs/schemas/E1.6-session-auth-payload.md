# E1.6 — Session / Auth Payload (Org + Branch)

## เป้าหมาย
- Auth session ต้องรู้ org และ branch
- ใช้เป็น base ของ RBAC / Subscription

---

## ตัวอย่าง Session Payload

```typescript
interface SessionPayload {
  clinicId: string;      // sub (legacy)
  email: string;
  org_id: string | null;
  branch_id: string | null;
  user_id: string | null;
}
```

**JWT claims ตัวอย่าง (หลัง login):**
```json
{
  "sub": "clinic_abc123",
  "email": "owner@clinic.com",
  "org_id": "org_xyz789",
  "branch_id": "branch_def456",
  "user_id": null
}
```

- `user_id`: ใช้เมื่อมี RBAC (E2) — ตอนนี้เป็น `null`
- `branch_id`: สาขา default — ถ้า org มีหลายสาขา ใช้ branch แรก

---

## จุดที่ Inject Context

### 1. Login (`src/app/api/auth/login/route.ts`)

หลัง verify password สำเร็จ:
1. `getOrgIdFromClinicId(clinicId)` — ดึง org_id จาก organizations ที่มี `_legacy_clinic_id == clinicId`
2. `getDefaultBranchId(orgId)` — ดึง branch แรกของ org
3. `createToken({ sub, email, org_id, branch_id, user_id: null })`

```
Login flow:
  clinic (email + licenseKey) → clinicId
       → getOrgIdFromClinicId(clinicId) → orgId
       → getDefaultBranchId(orgId) → branchId
       → createToken({ ..., org_id, branch_id })
```

### 2. Register (`src/app/api/auth/register/route.ts`)

Register **ไม่สร้าง session** — สร้าง clinic doc แล้ว return `clinicId`

- หลัง register ผู้ใช้ไป login
- Inject org/branch เกิดขึ้นที่ **Login** เท่านั้น
- หมายเหตุ: ถ้า Register สร้าง org+branch แทน clinic (E1.7+) จะต้องมี flow เพิ่ม

---

## Backward Compatibility

- **Legacy token** (ก่อน E1.6): ไม่มี `org_id`, `branch_id` ใน JWT
- `verifyToken` คืนค่า `org_id: null`, `branch_id: null` สำหรับ token เก่า
- API routes ใช้ `session.org_id ?? await getOrgIdFromClinicId(session.clinicId)` เพื่อรองรับทั้ง token เก่าและใหม่

---

## ไฟล์ที่แก้ไข

| ไฟล์ | การเปลี่ยนแปลง |
|------|----------------|
| `src/lib/session.ts` | TokenPayload, createToken, verifyToken รองรับ org_id, branch_id, user_id |
| `src/lib/auth-session.ts` | SessionPayload เพิ่ม org_id, branch_id, user_id |
| `src/lib/clinic-data.ts` | เพิ่ม `getDefaultBranchId(orgId)` |
| `src/app/api/auth/login/route.ts` | Inject org_id, branch_id ลง token |
| `src/app/api/clinic/me/route.ts` | ใช้ session.org_id ก่อน fallback getOrgIdFromClinicId |
