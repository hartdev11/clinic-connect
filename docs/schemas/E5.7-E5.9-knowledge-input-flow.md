# E5.7–E5.9 — Knowledge Input Flow

## Flow

```
Structured Input → Duplicate Detection → Conflict Resolution → Save → Embed → Vector DB
```

## Duplicate Rules

| Type     | Condition       | Action                    |
|----------|------------------|---------------------------|
| Exact    | text เท่ากันทุกประการ | warn → Replace / Keep / Cancel |
| Semantic | similarity > 0.85 | Replace / Keep / Cancel   |

## Conflict Resolution

- **Replace** — อัปเดต doc เดิม + upsert Pinecone
- **Keep** — ไม่บันทึก (ใช้ doc เดิม)
- **Cancel** — ยกเลิก

## API

**POST** `/api/clinic/knowledge`

**Body:**
```json
{
  "doc": {
    "level": "org",
    "org_id": "org_xyz",
    "topic": "filler",
    "category": "service",
    "key_points": ["ราคา 8,000–20,000"],
    "text": "ฟิลเลอร์ช่วยปรับรูปหน้า...",
    "is_active": true,
    "source": "manual"
  },
  "conflictResolution": "replace"
}
```

**Response (needs_resolution):**
```json
{
  "status": "needs_resolution",
  "duplicate": {
    "type": "exact" | "semantic",
    "existing": { ... },
    "score": 0.92
  }
}
```

**Response (saved/replaced/kept/cancelled):**
```json
{
  "status": "saved",
  "id": "doc_abc"
}
```

## Firestore

- Collection: `knowledge_documents`
- ใช้สำหรับ exact match และเก็บ full document
