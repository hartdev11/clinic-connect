# E1.3 — Migration & Rollback Strategy

## 1. Migration Approach

### Transaction ต่อ 1 clinic
- **เหตุผล:** สร้าง org + branch ต้องสำเร็จหรือล้มเหลวพร้อมกัน
- ถ้าใช้ batch แยก: create org สำเร็จ แต่ create branch fail → จะมี org ที่ไม่มี branch
- Transaction: `runTransaction` ทำให้ทั้งคู่ atomic

### Skip logic
- Query `organizations` where `_legacy_clinic_id == clinicId`
- ถ้าเจอ → skip ( migrate แล้ว )

### Dry-run
- ไม่เรียก `tx.set()` ใน Firestore
- แค่ log ว่าจะสร้าง org/branch อะไรบ้าง

---

## 2. Rollback Strategy

### วิธีตรวจ organization/branch ที่สร้างจาก clinic เดิม

```javascript
// ตรวจ org ที่มาจาก clinic X
db.collection("organizations").where("_legacy_clinic_id", "==", "clinicId เดิม").get();

// ตรวจ branch ของ org นั้น
db.collection("branches").where("org_id", "==", "orgId").get();
```

### ขั้นตอน Rollback (เชิงปฏิบัติ)

1. **Backup ก่อน migration**
   - Export Firestore: `gcloud firestore export gs://BUCKET/backup-YYYYMMDD`
   - หรือใช้ Firebase Console Backup

2. **ระบุ records ที่ต้องลบ**
   - Query ทุก org ที่มี `_legacy_clinic_id != null`
   - สำหรับแต่ละ org: หา branches ที่ `org_id == org.id`

3. **ลบ records (ถ้าต้อง rollback)**
   - ลบ branches ก่อน (มี FK org_id)
   - ลบ organizations ภายหลัง
   - **ไม่ลบ clinics**

4. **Rollback script (ตัวอย่าง)**
   ```bash
   # ยังไม่ implement — ใช้เมื่อจำเป็น
   npx tsx scripts/rollback-migration.ts --dry-run
   ```

5. **ตรวจสอบหลัง rollback**
   - clinics ยังอยู่ครบ
   - organizations, branches ที่ migrate ถูกลบ
   - API ยังใช้ clinicId ได้ (dual-read ช่วงเปลี่ยนผ่าน)

---

## 3. E1.3 Definition of Done

- [ ] clinics ทุกตัวมี organization ใหม่
- [ ] ทุก organization มี branch เริ่มต้น 1 อัน ("สาขาหลัก")
- [ ] ไม่มีข้อมูล clinic ถูกลบ
- [ ] _legacy_clinic_id ถูกต้องทุก record (org._legacy_clinic_id == clinic.id)
- [ ] Script รันซ้ำได้โดยไม่ duplicate (skip ถ้า _legacy_clinic_id มีอยู่แล้ว)
- [ ] มี log สำหรับตรวจสอบย้อนหลัง
- [ ] รองรับ dry-run mode

## 4. การรัน Migration

```bash
# 1. Dry-run ก่อน (ไม่เขียน Firestore)
npm run migrate:clinics-to-orgs:dry
# หรือ: npx tsx scripts/migrate-clinics-to-orgs.ts --dry-run

# 2. รันจริง
npm run migrate:clinics-to-orgs
# หรือ: npx tsx scripts/migrate-clinics-to-orgs.ts
```

**หมายเหตุ:** ต้องติดตั้ง tsx ก่อน (`npm install -D tsx`) หรือใช้ `npx tsx` (npx จะดาวน์โหลดให้)
