# E2.9 — Org + Branch Role Support (Addendum)

## แยกชัด: Org role vs Branch role

| Level | Field | Type | หมายเหตุ |
|-------|-------|------|----------|
| **Org** | role | owner \| manager \| staff | role ระดับองค์กร |
| **Branch** | branch_roles | { [branchId]: manager \| staff } | role ต่อสาขา (owner ไม่ใช้) |

---

## Schema (users collection)

| Field | Type | หมายเหตุ |
|-------|------|----------|
| role | string | org-level: owner \| manager \| staff |
| branch_ids | string[] | legacy — สาขาที่เข้าถึงได้ (เมื่อไม่มี branch_roles) |
| branch_roles | map | { branchId: "manager" \| "staff" } — role ต่อสาขา |

---

## Permission Check (แยกชัด)

```
1. org_role === "owner" → ALLOW (ทุกสาขา), effective_role = owner

2. branch_roles[branchId] มีค่า
   → ALLOW, effective_role = branch_roles[branchId]

3. branch_ids.includes(branchId) (legacy)
   → ALLOW, effective_role = org_role

4. else → DENY
```

---

## getEffectiveRoleAtBranch(branchId)

- owner → "owner"
- branch_roles[branchId] → return it
- branch_ids.includes(branchId) → org_role
- else → null (no access)
