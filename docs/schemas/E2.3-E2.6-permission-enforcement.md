# E2.3–E2.6 — Permission Enforcement

## สรุปการ Implement

| ไฟล์ | การเปลี่ยนแปลง |
|------|----------------|
| `src/lib/rbac.ts` | requireRole(), requireBranchAccess(), getEffectiveUser() |
| `src/lib/clinic-data.ts` | getUserById(), COLLECTIONS.users |
| `src/app/api/clinic/*` | bookings, customers, dashboard, finance, promotions — เพิ่ม RBAC check + ส่ง branchId |

---

## Permission Matrix

| Action / Resource | owner | manager | staff |
|-------------------|-------|---------|-------|
| ดูข้อมูล org | ✅ | ✅ | ✅ |
| แก้ไข org, plan | ✅ | ❌ | ❌ |
| จัดการ branches | ✅ | ✅* | ❌ |
| จัดการ users (invite, role) | ✅ | ✅* | ❌ |
| ดู/แก้ไข bookings | ✅ (ทุกสาขา) | ✅ (branch_ids) | ✅ (branch_ids) |
| ดู/แก้ไข customers | ✅ | ✅ | ✅ |
| ดู/แก้ไข finance | ✅ | ✅ | ✅ |
| ดู/แก้ไข promotions | ✅ | ✅ | ✅ |

\* manager: เฉพาะสาขาใน branch_ids (ถ้า branch_ids ว่าง = ทั้ง org)

---

## Branch-scoped Check Logic

```
branch_id ถูกขอ (จาก query/body/session)
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│ role == owner  → ALLOW (เข้าถึงทุกสาขา)                          │
└─────────────────────────────────────────────────────────────────┘
         │ else
         ▼
┌─────────────────────────────────────────────────────────────────┐
│ branch_ids == null || branch_ids.length == 0  → ALLOW (ทั้ง org) │
└─────────────────────────────────────────────────────────────────┘
         │ else
         ▼
┌─────────────────────────────────────────────────────────────────┐
│ branch_id ∈ branch_ids  → ALLOW                                  │
│ else                     → DENY (403)                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## ตัวอย่าง Middleware / Helper

### requireRole()

```typescript
// src/lib/rbac.ts

import type { SessionPayload } from "@/lib/auth-session";

export type AllowedRole = "owner" | "manager" | "staff";

/** ตรวจว่า session มี role ที่อนุญาต (ต้องโหลด user จาก DB ถ้า session ไม่มี role) */
export function requireRole(
  session: SessionPayload,
  userRole: AllowedRole | null,
  allowed: AllowedRole[]
): boolean {
  if (!userRole) return false;
  return allowed.includes(userRole);
}
```

### requireBranchAccess()

```typescript
// src/lib/rbac.ts (ต่อ)

/** ตรวจ branch-scoped: owner → allow; else → branch_id ∈ branch_ids */
export function requireBranchAccess(
  userRole: "owner" | "manager" | "staff",
  userBranchIds: string[] | null | undefined,
  requestedBranchId: string | null
): boolean {
  // ไม่มีการขอ branch เฉพาะ = อนุญาต (ใช้ session.branch_id หรือ default)
  if (!requestedBranchId) return true;

  if (userRole === "owner") return true;

  if (!userBranchIds || userBranchIds.length === 0) return true;

  return userBranchIds.includes(requestedBranchId);
}
```

### API Route Example

```typescript
// ตัวอย่างใช้ใน API route

export async function GET(request: NextRequest) {
  const session = await getSessionFromRequest(request);
  if (!session) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const orgId = session.org_id ?? (await getOrgIdFromClinicId(session.clinicId));
  if (!orgId) return NextResponse.json({ error: "Org not found" }, { status: 404 });

  // โหลด user (role, branch_ids)
  const user = await getUserById(session.user_id ?? session.clinicId);
  if (!user) return NextResponse.json({ error: "User not found" }, { status: 404 });

  const branchId = request.nextUrl.searchParams.get("branchId") ?? session.branch_id;

  if (!requireBranchAccess(user.role, user.branch_ids, branchId)) {
    return NextResponse.json({ error: "Forbidden: no access to this branch" }, { status: 403 });
  }

  // ... ดำเนินการต่อ
}
```

---

## Flow Diagram

```
Request → getSession() → session.org_id, session.user_id, session.branch_id
                              │
                              ▼
                    getUser(user_id) → user.role, user.branch_ids
                              │
                              ▼
                    requireBranchAccess(role, branch_ids, requestedBranchId)
                              │
                    ┌─────────┴─────────┐
                    ▼                   ▼
                  ALLOW              DENY 403
```
