# E4.2–E4.5 — RAG Integration

## สรุป

- Refactor `knowledge.ts` → ใช้ RAG (searchKnowledgeWithPyramid)
- Error → fallback static KNOWLEDGE_BASE
- Pipeline: เพิ่ม context เท่านั้น (ไม่เปลี่ยน flow A→B→E→C→D→F)

## การทำงาน

1. **getKnowledge()** (async)
   - RAG ก่อน: searchKnowledgeWithPyramid(query, pyramidContext)
   - Query: service + area + intent + userMessage
   - Pyramid: ใช้ org_id, branch_id จาก options (ไม่มี → global)
   - Success: รวม ragContext เข้า KnowledgeResult
   - Error: fallback เป็น static KNOWLEDGE_BASE

2. **Pipeline**
   - เรียก getKnowledge ก่อน composeReply (ตอน fallback ไป AI)
   - ส่ง knowledge (含 ragContext) ให้ composeReply
   - runPipeline ตอนนี้รับ options?: { org_id?, branch_id? } สำหรับ pyramid

3. **Flow** — ไม่เปลี่ยน
   - A (Intent) → B (Safety) → E (Escalation) → C (Knowledge) → D (Compose) → F (Memory)

## Metadata สำหรับ RAG

- `content` — เก็บใน Pinecone metadata ตอน upsert (doc.text slice 2000 ตัวอักษร)
- ใช้ buildRagContext() แปลง search results เป็น string ให้ AI
