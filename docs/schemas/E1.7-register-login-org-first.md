# E1.7 — Register / Login Flow (Org-first)

## เป้าหมาย
- สร้าง org + branch แทน clinic
- User แรก = owner

---

## Flow Diagram

### Register
```
Input: licenseKey, clinicName, branches, phone, email, password
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 1. Validate: licenseKey unique, email unique (users + clinics)      │
└─────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 2. Transaction:                                                      │
│    - Create organization (name, plan, licenseKey, phone, email)      │
│    - Create default branch ("สาขาหลัก")                              │
│    - Create user (org_id, email, passwordHash, role=owner,           │
│                  default_branch_id)                                  │
└─────────────────────────────────────────────────────────────────────┘
         │
         ▼
Response: { success: true, orgId, branchId }
```

### Login
```
Input: licenseKey, email, password
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 1. Try org-first:                                                    │
│    - Find org by licenseKey                                          │
│    - Find user by org_id + email                                     │
│    - Verify password                                                 │
│    → success: createToken(user_id, org_id, branch_id, email)         │
└─────────────────────────────────────────────────────────────────────┘
         │ (fallback ถ้าไม่เจอ)
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 2. Legacy clinic:                                                    │
│    - Find clinic by email, verify licenseKey + password              │
│    - getOrgIdFromClinicId, getDefaultBranchId (migration path)       │
│    → createToken(clinicId, org_id, branch_id, user_id=null)          │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Collections

| Collection | E1.7 fields |
|------------|-------------|
| **organizations** | + licenseKey (สำหรับ login lookup) |
| **branches** | — |
| **users** (ใหม่) | org_id, email, passwordHash, role, default_branch_id, createdAt, updatedAt |

---

## ตัวอย่าง Payload

### Register Response
```json
{
  "success": true,
  "orgId": "org_xyz789",
  "branchId": "branch_def456"
}
```

### JWT / Session (org-first login)
```json
{
  "sub": "user_abc123",
  "email": "owner@clinic.com",
  "user_id": "user_abc123",
  "org_id": "org_xyz789",
  "branch_id": "branch_def456"
}
```

### JWT / Session (legacy clinic login)
```json
{
  "sub": "clinic_old123",
  "email": "owner@clinic.com",
  "user_id": null,
  "org_id": "org_xyz789",
  "branch_id": "branch_def456"
}
```

---

## ไฟล์ที่แก้ไข

| ไฟล์ | การเปลี่ยนแปลง |
|------|----------------|
| `src/types/organization.ts` | + licenseKey, User, UserCreate, UserRole |
| `src/app/api/auth/register/route.ts` | สร้าง org + branch + user แทน clinic |
| `src/app/api/auth/login/route.ts` | ลอง org-first ก่อน, fallback clinic |
| `firestore.indexes.json` | + organizations.licenseKey, users.(org_id+email), users.email |
